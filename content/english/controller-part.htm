<h2 id="controller-part">Controller Part</h2><p>NodeAtlas is useful for more than simply generate template web page easily based on your variations files. NodeAtlas allow you to dynamically interact with variations var and with the DOM with usage of:</p><ul>
<li>parameters in the query part of URL (GET),</li>
<li>parameters in request body (POST),</li>
</ul><p>but also, using natives features from Node.js or npm, interact usage of:</p><ul>
<li>data from files,</li>
<li>data from databases,</li>
<li>data from  active user sessions,</li>
<li>data provide from WebSockets exchanges,</li>
<li>and more!</li>
</ul><h3 id="lifecycle">Lifecycle</h3><p>NodeAtlas lifecycle works as following. First, resources are loaded, the server start, routes are added and all is up. Then, for each HTTP request, a response is generated. You could use hooks while server start and while the response is constructed.</p><p>This is a <code>webconfig.json</code> allows you to manipulate each hook of lifecycle of a page.</p><pre><code class="language-json">{
    "controllersRelativePath": "controllers",
    "controller": "common.js",
    "routes": {
        "/": {
            "view": "index.htm",
            "controller": "index.json"
        }
    }
}</code></pre><p><em>Note: if</em> <code>controllersRelativePath</code> <em>is not present in <code>webconfig.json</code>, default controller folder is</em> <code>controllers</code>. <code>controllersRelativePath</code> <em>is useful only to change the name/path of directory.</em></p><p>and this is all hooks you can use while:</p><h4 id="starting-the-server">Starting the server</h4><pre><code class="language-txt">┌─[Loading Node.js Modules]
┊
├─[Loading Init Vars]
┊
├─[Loading npm Modules]
┊
├─[Setting CLI Commands and Language]
┊
├─[Setting API Options]
┊
└─[Loading CLI Language]
  ┊
  ├─[Loading Global Vars]
  ┊
  ├─[Setting Webconfig Instructions]
  ┊
  └─[Loading Common Controller]
    ┊  ______________________________
    ├─{Hook : &lt;controller&gt;.setModules}
    ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    ├─[Server Init]
    ┊  _______________________________
    ├─{Hook : &lt;controller&gt;.setSessions}
    ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    ├─[Sessions Init]
    ┊
    ├─[Sockets Init]
    ┊ ┊  ______________________________
    ┊ ├─{Hook : &lt;controller&gt;.setSockets}_______
    ┊ └─{Hook : routes[&lt;controller&gt;].setSockets}
    ┊    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    ┊  _____________________________________
    ├─{Hook : &lt;controller&gt;.setConfigurations}
    ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    └─[Starting the server]
      ┊
      ├─[Template Engine Init]
      ┊  _____________________________
      ├─{Hook : &lt;controller&gt;.setRoutes}
      ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
      └─[Routes Init]
        ┊
        ∞</code></pre><h4 id="processing-a-request">Processing a request</h4><pre><code class="language-txt">∞
┊
└─[Processing a request]
  ┊
  └─[Loading Specific Controller]
    ┊  ____________________________________
    ├─{Hook : &lt;controller&gt;.changeVariations}_______
    ├─{Hook : routes[&lt;controller&gt;].changeVariations}
    ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    └─[Template Engine Compilation]
      ┊  _____________________________
      ├─{Hook : &lt;controller&gt;.changeDom}_______
      ├─{Hook : routes[&lt;controller&gt;].changeDom}
      ┊  ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
      └─[Send Response]
        ┊
        ∞</code></pre><h3 id="changevariations-hook"><code>changeVariations</code> Hook</h3><p>In order to intercept variations, you could use the common controller for all the website page and/or also a specific controller per page.</p><p><code>changeVariations(next, locals, request, response)</code> is a function to <code>exports</code> and provide:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
<li>A callback function <code>next()</code> in the first argument.</li>
<li>An object <code>locals</code> in the second argument with the <code>locals.common</code> for common variations and the <code>locals.specific</code> for specific variations.</li>
<li>The <code>request</code> object in the third argument for this page.</li>
<li>The <code>response</code> object in the fourth argument for this page.</li>
</ul><p>This is an example using the two hooks, the common in first and after the specific:</p><pre><code class="language-json">{
    "urlRelativeSubPath": "example",
    "controller": "common.js",
    "variation": "common.json",
    "routes": {
        "/": {
            "view": "index.htm",
            "variation": "index.json",
            "controller": "index.js"
        }
    }
}</code></pre><p>with this files :</p><pre><code class="language-txt">├─ variations/
│  ├─ common.json
│  └─ index.json
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  ├─ partials/
│  │  ├─ head.htm
│  │  └─ foot.htm
│  └─ index.htm
└─ webconfig.json</code></pre><p>Do a POST request on <code>http://localhost/example/?title=MachinisteWeb</code> with <code>example=This+is+a+test</code> variable in body will use the following files:</p><p><em>variations/common.json</em></p><pre><code class="language-json">{
    "titleWebsite": "Site Title"
}</code></pre><p><em>variations/index.json</em></p><pre><code class="language-json">{
    "titlePage": "Welcome",
    "content": "&lt;p&gt;This is the Home Page.&lt;/p&gt;"
}</code></pre><p><em>views/index.htm</em></p><pre><code class="language-html">    &lt;?- include("partials/head.htm") ?&gt;

    &lt;div class="title"&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;

    &lt;div&gt;
        &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
        &lt;?- specific.content ?&gt;
    &lt;/div&gt;

    &lt;?- include("partials/foot.htm") ?&gt;</code></pre><p><em>controllers/common.js</em></p><pre><code class="language-js">// This code is executed before variation are injected into template engine.
// This code is executed for all HTTP request, for all pages.
exports.changeVariations = function (next, locals, request, response) {

    // Here we update `locals` variable.

    console.log(locals.common.titleWebsite); // `"Site Title"`
    console.log(locals.specific.titlePage); // `"Welcome"`
    console.log(locals.specific.content); // `"This is the Home Page."`

    console.log("urlRootPath", locals.urlRootPath); // `"http://localhost"`
    console.log("urlSubPath", locals.urlSubPath); // `"/example"`
    console.log("urlBasePath", locals.urlBasePath); // `"http://localhost/example"`
    console.log("urlFilePath", locals.urlFilePath); // `"/"`
    console.log("urlQueryPath", locals.urlQueryPath); // `"?title=MachinisteWeb"`
    console.log("urlPath", locals.urlPath); // `"http://localhost/example/?title=MachinisteWeb"`

    if (request.query["title"]) {
        locals.specific.titlePage = locals.specific.titlePage + " " + request.query.title;
    }
    if (request.body["example"]) {
        locals.specific.content = request.body.example;
    }

    console.log(locals.common.titleWebsite); // `"Site Title"`
    console.log(locals.specific.titlePage); // "Welcome MachinisteWeb"
    console.log(locals.specific.content); // `"This is a test"`

    // We continue with next steps.
    next();
};</code></pre><p><em>controllers/index.js</em></p><pre><code class="language-js">// This code is executed before variation are injected into template engine.
// This code is executed only for the `/` page.
exports.changeVariations = function (next, locals, request, response) {

    // Here we update `locals` variable.

    console.log(locals.common.titleWebsite); // `"Site Title"`
    console.log(locals.specific.titlePage); // `"Welcome MachinisteWeb"`
    console.log(locals.specific.content); // `"This is a test"`

    locals.common.titleWebsite = `"It's Home, no way."`;
    locals.specific.content = `"It's Home, no way."`;

    console.log(locals.common.titleWebsite); // `"It's Home, no way."`
    console.log(locals.specific.titlePage); // `"Welcome MachinisteWeb"`
    console.log(locals.specific.content); // `"It's Home, no way."`

    // We continue with next steps.
    next();
};</code></pre><p>this produce the following output:</p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;It's Home, no way.&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;It's Home, no way.&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Welcome MachinisteWeb&lt;/h1&gt;
            It's Home, no way.
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p>If you delete the variation entry of specific page from webconfig:</p><pre><code class="language-json">{
    "controller": "common.js",
    "variation": "common.json",
    "routes": {
        "/": {
            "view": "index.htm",
            "variation": "index.json"
        }
    }
}</code></pre><p>the output will be the following:</p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;Site Title&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;Site Title&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Welcome MachinisteWeb&lt;/h1&gt;
            This is a test
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><h3 id="changedom-hook"><code>changeDom</code> Hook</h3><p>In order to intercept DOM before it was sent, you could use the common controller for all the website page and/or also a specific controller per page.</p><p><code>changeDom(next, locals, request, response)</code> is a function to <code>exports</code> and provide :</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
<li>A callback function <code>next([dom])</code> in the first argument which accepts an optional first updated <code>dom</code> argument used to manipulate the Virtual DOM.</li>
<li>An object <code>locals</code> in the second argument with the <code>locals.dom</code> string that contains the response or the <code>locals.virtualDom()</code> function creating a usable Virtual DOM.</li>
<li>The <code>request</code> object in the third argument for this page.</li>
<li>The <code>response</code> object in the fourth argument for this page.</li>
</ul><p>This is an example using the two hooks, the common for all pages in first and after the specific:</p><pre><code class="language-json">{
    "controller": "common.js",
    "variation": "common.json",
    "routes": {
        "/": {
            "view": "index.htm",
            "variation": "index.json",
            "controller": "index.js"
        }
    }
}</code></pre><p>with this files:</p><pre><code class="language-txt">├─ variations/
│  ├─ common.json
│  └─ index.json
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json</code></pre><p>Do a request on <code>http://localhost/</code> will use the following files (and others):</p><p><em>variations/common.json</em></p><pre><code class="language-json">{
    "titleWebsite": "Site Title"
}</code></pre><p><em>variations/index.json</em></p><pre><code class="language-json">{
    "titlePage": "Welcome",
    "content": "&lt;p&gt;This is Home Page.&lt;/p&gt;"
}</code></pre><p><em>views/index.htm</em></p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;?- specific.content ?&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p><em>controllers/common.js</em></p><pre><code class="language-js">// This code is executed before DOM was sent to client.
// This code is executed for all HTTP request, for all pages.
exports.changeDom = function (next, locals, request, response) {
    // Transform HTML string into Virtual DOM.
    var $ = locals.virtualDom();

    // Just after eath h1 from HTML of `dom`...
    Array.prototype.forEach.call(dom.window.document.getElementsByTagName("h1"), function (h1) {

        // ...we create a div,
        var div = dom.window.document.createElement('div');

        // ...we inject the content of h1 into the div...
        div.innerHTML = h1.innerHTML;
        h1.parentNode.insertBefore(div, h1.nextElementSibling);

        // ...and we delete the h1.
        h1.parentNode.removeChild(h1);
    });

    // Return updates for reinject them into HTML string.
    next(dom);
};</code></pre><p><em>controllers/index.js</em></p><pre><code class="language-js">// This code is executed before DOM was sent to client.
// This code is executed only for the « / » page .
exports.changeDom = function (next, locals, request, response) {
    var NA = this,
        jsdom = NA.modules.jsdom, // `jsdom` for manipulate Virtual DOM.
        dom = new jsdom.JSDOM(locals.dom); // We load datas for manipulate it as a DOM.

    // We update node content with `.title` class.
    dom.window.document.getElementsByClassName("title")[0].textContent = "Content Update";

    // We recreate a new HTML output with updates.
    locals.dom = dom.serialize();

    // We go to next step.
    next();
};</code></pre><p>the output will be as following:</p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;title&gt;Site Title&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;Content Update&lt;/div&gt;
        &lt;div&gt;
            &lt;div&gt;Welcome&lt;/div&gt;
            &lt;p&gt;This is Home Page.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><h3 id="setsockets-hook"><code>setSockets</code> Hook</h3><p>In order to keep a real-time connection between your client-side and server-side across all pages opened on all browsers that run on all OS, you could define your WebSockets here. <a href="controller-part.html#websockets-exchanges">More details in Socket.IO part</a>.</p><p><code>setSockets()</code> is a function to <code>exports</code> and providing:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
</ul><p>This is an example using the two hooks, the common in first and after the specific:</p><pre><code class="language-json">{
    "socketClientFile": "/node-atlas/socket.io.js",
    "socketServerOptions": { "transports": ["polling", "websocket"] },
    "controller": "common.js",
    "routes": {
        "/": {
            "view": "index.htm",
            "controller": "index.js"
        }
    }
}</code></pre><p>with this files:</p><pre><code class="language-txt">├─ assets/
│  └─ javascripts/
│     └─ index.js
├─ controllers/
│  ├─ common.js
│  ├─ index.js
│  └─ test.js
├─ views/
│  └─ index.htm
└─ webconfig.json</code></pre><p>Do a request on <code>http://localhost/</code> will use the following files (and others files):</p><p><em>views/index.htm</em></p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;Websocket Example&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="layout"&gt;
            &lt;div class="content"&gt;&lt;/div&gt;
            &lt;div class="field"&gt;Write something : &lt;input class="input" type="text"&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;script type="text/javascript" src="socket.io/socket.io.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="node-atlas/socket.io.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="javascripts/test.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="javascripts/index.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p><em>Note: if</em> <code>socketClientFile</code> <em>and</em> <code>socketServerOptions</code> <em>are not present in <code>webconfig.json</code>, default client file and server options for sockets for config sockets are</em> <code>/node-atlas/socket.io.js</code> <em>and</em> <code>{ transports: ['polling', 'websocket'] }</code>. <code>socketClientFile</code>. <em>They are useful only to change the name of file or the sockets transports alloweds. If you set <code>socketClientFile</code> to <code>false</code>, the client file will be not adding on accessible routes.</em></p><p><em>assets/javascripts/test.js</em></p><pre><code class="language-js">(function (expose, factory) {
    if (typeof module !== 'undefined' &amp;&amp; module.exports) {
        module.exports = factory;
    } else {
        expose.Test = factory;
    }
}(this, function () {
    if (NA.isClient) {
        console.log("Client");
    } else {
        console.log("Server");
    }
}));</code></pre><p><em>controllers/common.js</em></p><pre><code class="language-js">// This code is executed for each WebSocket request/response on server.
// This code is executed for all WebSocket from Client.
exports.setSockets = function () {
    var NA = this,
        io = NA.io;

    io.on('connection', function (socket) {
        console.log("A tab is opened.");
        socket.on('disconnect', function () {
            console.log("A tab is closed.");
        });
    });
};</code></pre><p><em>controllers/index.js</em></p><pre><code class="language-js">// This code is executed for each WebSocket request/response on server.
// This code is executed for all WebSocket from client.
exports.setSockets = function () {
    var NA = this,
        path = NA.modules.path,
        io = NA.io;

    require(path.join(NA.serverPath, NA.webconfig.assetsRelativePath, "javascripts/test.js"))(); // display `Server`

    // Wait for a valid connection between client and servere.
    io.sockets.on("connection", function (socket) {

        // A page says the text has changed.
        socket.on("update-text", function (data) {

            // We say to all others page the page has changed.
            io.sockets.emit("update-text", data);
        });
    });
};</code></pre><p><em>assets/javascripts/index.js</em></p><pre><code class="language-js">var content = document.getElementsByClassName("content")[0],
    input = document.getElementsByClassName("input")[0];

Test(); // display `Client`

// We say to others we just change text.
input.addEventListener("keyup", function () {
    content.innerHTML = input.value;
    NA.socket.emit("update-text", {
        text: input.value
    });
});

// Others says they changed the text.
NA.socket.on("update-text", function (data) {
    content.innerHTML = data.text;
    input.value = data.text;
});</code></pre><p>You will see, opening different browsers and tabs. All is updated in all tabs. Each tab open display the connection message and each tab closed display the disconnection message on the server console.</p><p><em>Note: you can change the <code>node-atlas/socket.io.js</code> file by a file provided by you in order to change <code>optionsSocket</code> variable. You can also change <code>NA.optionsSocket</code> in a front-side file, before inserting of <code>node-atlas/socket.io.js</code> with a custom option object.</em></p><h3 id="setmodules-hook"><code>setModules</code> Hook</h3><p>To load others modules which not include into NodeAtlas, you can use the common controller for all the website in order to load it once and use modules anywhere in all controllers.</p><p><code>setModules()</code> is a function to <code>exports</code> and providing:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
</ul><p>This is an example using an external module of NodeAtlas:</p><pre><code class="language-json">{
    "controller": "common.js",
    "routes": {
        "/": {
            "view": "index.htm",
            "controller": "index.js"
        }
    }
}</code></pre><p>with this set of files:</p><pre><code class="language-txt">├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json</code></pre><p>Do a request on <code>http://localhost/</code> will use the following files (and others files):</p><p><em>views/index.htm</em></p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;Module Test&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;Module Test&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Module Test&lt;/h1&gt;
            &lt;?- example ?&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p><em>controllers/common.js</em></p><pre><code class="language-js">// This code is executing during the modules loading phase.
// This code will be executed when NodeAtlas starting.
exports.setModules = function () {
    // Use the NodeAtlas instance from engine.
    var NA = this;

    // Associate each modules to allow us to use them anywhare.
    NA.modules.marked = require('marked');
};</code></pre><p><em>controllers/index.js</em></p><pre><code class="language-js">// This code is executed before variation are injected into template engine.
// This code is executed only for the `/` page .
exports.changeVariations = function (next, locals) {
    // Use the NodeAtlas instance from engine.
    var NA = this,
        marked = NA.modules.marked;

    variations.example = marked("I am using __markdown__.");

    // We do next step.
    next();
};</code></pre><p>this will produce the following output:</p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;Module Test&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="title"&gt;Module Test&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Module Test&lt;/h1&gt;
            &lt;p&gt;I am using &lt;strong&gt;markdown&lt;/strong&gt;.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><h3 id="setconfigurations-hook"><code>setConfigurations</code> Hook</h3><p>To configure NodeAtlas web server others (<a href="http://expressjs.com/">Express</a>), you can use the common controller to set configurations before the server start.</p><p><code>setConfigurations(next)</code> is a function to <code>exports</code> and providing:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
<li>A callback function <code>next()</code> in first argument.</li>
</ul><p>This is an example using a middleware for <a href="http://expressjs.com/">Express</a>:</p><pre><code class="language-json">{
    "controller": "common.js",
    "routes": {
        "/": {
            "view": "index.htm",
            "controller": "index.js"
        }
    }
}</code></pre><p>with this set of files:</p><pre><code class="language-txt">├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json</code></pre><p>Do a request on <code>http://localhost/</code> will use the following files (and others files):</p><p><em>views/index.htm</em></p><pre><code class="language-html">&lt;?- content ?&gt;</code></pre><p><em>controllers/common.js</em></p><pre><code class="language-js">// This code is executing before starting of the web server.
// This code will be executed when NodeAtlas starting.
exports.setConfigurations = function (next) {
    // Use the NodeAtlas instance from engine.
    var NA = this;

    // Middleware used for each request.
    NA.express.use(function (request, response, next) {
        response.setHeader("X-Frame-Options", "ALLOW-FROM https://www.lesieur.name/");
        next();
    });

    // We do next steps.
    next();
};</code></pre><p><em>controllers/index.js</em></p><pre><code class="language-js">// This code is executing before starting of the web server.
// This code is executed only for the `/` page .
exports.changeVariations = function (next, locals) {

    // We prepare file for JSON displaying.
    locals.routeParameters.headers = {
        "Content-Type": "application/json; charset=utf-8"
    };
    locals.content = JSON.stringify(locals, null, "    ");

    // We do the next step.
    next();
};</code></pre><p>this will produce the following output:</p><pre><code class="language-html">{
    "urlRootPath": "http://localhost",
    "urlSubPath": "",
    "urlBasePath": "http://localhost",
    "urlFilePath": "/",
    "urlQueryPath": "",
    "urlPath": "http://localhost/",
    "params": {},
    "query": {},
    "body": {},
    "routeParameters": { /* ... */ },
    "route": "/",
    "webconfig": { /* ... */ }
}</code></pre><h3 id="setsessions-hook"><code>setSessions</code> Hook</h3><p>To configure client-server Sessions of NodeAtlas, you can use the common controller to set sessions before the server start. this is an example with <a href="http://redis.io/">Redis</a> sessions.</p><p><code>setSessions(next)</code> is a function to <code>exports</code> and providing:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
<li>A callback function <code>next()</code> in first parameter.</li>
</ul><p>This is all files for example:</p><pre><code class="language-txt">├─ controllers/
│  └─ common.js
├─ views/
│  └─ index.htm
├─ variations/
│  ├─ common.json
│  └─ index.json
└─ webconfig.json</code></pre><p>With the <code>webconfig.json</code>:</p><pre><code class="language-json">{
    "controller": "common.js",
    "routes": {
        "/": {
            "view": "index.htm"
        }
    }
}</code></pre><p>And <code>common.js</code> file containing e.g.:</p><pre><code class="language-js">// This code is executing during the modules loading phase.
// This code will be executed when NodeAtlas starting.
exports.setModules = function () {
    // Find instance of NodeAtlas engine.
    var NA = this;

    // Associations of each module to access it anywhere.
    NA.modules.RedisStore = require('connect-redis');
};

// This code is executing while configuration of session.
// This code will be executed when NodeAtlas starting.
exports.setSessions = function (next) {
    var NA = this,
        session = NA.modules.session,
        RedisStore = NA.modules.RedisStore(session);

    // We replace the default session.
    NA.sessionStore = new RedisStore();

    // We do next steps.
    next();
};</code></pre><h3 id="setroutes-hook"><code>setRoutes</code> Hook</h3><p>To configure routes of NodeAtlas by programmation, you can use the common controller for all the website in order to load it once and use modules anywhere in all controllers.</p><p><code>setRoutes(next)</code> is a function to <code>exports</code> and providing:</p><ul>
<li><code>NA</code> object as <code>this</code>.</li>
<li>A callback function <code>next()</code> in first argument.</li>
</ul><p>This is all files for example:</p><pre><code class="language-txt">├─ controllers/
│  └─ common.js
├─ views/
│  ├─ content.htm
│  └─ index.htm
├─ variations/
│  └─ common.json
└─ webconfig.json</code></pre><p>With the <code>webconfig.json</code>:</p><pre><code class="language-json">{
    "controller": "common.js",
    "variation": "common.json",
    "routes": {
        "/index.html": {
            "view": "index.htm"
        }
    }
}</code></pre><p>And <code>common.js</code> file containing e.g.:</p><pre><code class="language-js">// This code is executing while route are added.
// This code will be executed when NodeAtlas starting.
exports.setRoutes = function (next) {

    // We use instance of NodeAtlas.
    var NA = this,

        // And we keep routes from NodeAtlas webconfig...
        route = NA.webconfig.routes;

    // ...to add "/content.html" route amongs others routes.
    route["/content.html"] = {
        "view": "content.htm"
    };

    // We do next steps.
    next();
};</code></pre><h3 id="websockets-exchanges">Websockets Exchanges</h3><p>To keep a link between client-side and server-side part of the website, NodeAtlas use <a href="http://socket.io/">Socket.IO</a> (more details on official website).</p><p>Thanks to this, you could change in real-time data on your page, but also change data from another tabs or browsers.</p><p>With this following files:</p><pre><code class="language-txt">├─ assets/
│  └─ javascripts/
│     └─ index.js
├─ controllers/
│  └─ index.js
├─ variations/
│  ├─ common.json
│  └─ index.json
├─ views/
│  ├─ partials/
│  │  └─ index.htm
│  └─ index.htm
└─ webconfig.json</code></pre><p>With this <code>webconfig.json</code>:</p><pre><code class="language-json">{
    "variation": "common.json",
    "routes": {
        "/": {
            "view": "index.htm",
            "variation": "index.json",
            "controller": "index.js"
        }
    }
}</code></pre><p>and with this views files:</p><p><em>views/partials/index.htm</em></p><pre><code class="language-html">        &lt;div class="title"&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;?- specific.content ?&gt;
            &lt;div&gt;&lt;?- new Date() ?&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;button&gt;Update&lt;/button&gt;</code></pre><p><em>Note: each click on <code>button</code> will update content from <code>views/partials/index.htm</code>.</em></p><p><em>views/index.htm</em></p><pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en-us"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="layout"&gt;
            &lt;?- include('partials/index.htm') ?&gt;
        &lt;/div&gt;
        &lt;script type="text/javascript" src="socket.io/socket.io.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="node-atlas/socket.io.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="javascripts/index.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p><em>Note: we parse here the home page <code>/</code>.</em></p><p>and the following variations files:</p><p><em>variations/common.json</em></p><pre><code class="language-json">{
    "titleWebsite": "Socket.IO Example"
}</code></pre><p><em>variations/index.json</em></p><pre><code class="language-json">{
    "titlePage": "Date",
    "content": "&lt;p&gt;Current date is:&lt;/p&gt;"
}</code></pre><p>All work fine here, but see what we will do with controller part on server-side and on client-side.</p><p>On server, we will use the following controller file:</p><p><em>controllers/index.js</em></p><pre><code class="language-js">// All WebSocket action possible with `setSockets`.
exports.setSockets = function () {
    var NA = this,
        io = NA.io;

    // Once we have a valid connection between the client and our server...
    io.sockets.on('connection', function (socket) {

        // ...stay tuned on the `server-render` request...
        socket.on("server-render", function (data) {
            var sessionID = socket.request.sessionID,
                session = socket.request.session,
                locals = {};

            // Specific variations in the good language.
            locals = NA.specific("index.json", data.lang, locals);

            // Common variations in the good language.
            locals = NA.common(data.lang, locals);

            // HTML part from `viewsRelativePath` directory and render with variations.
            result = NA.view("partials/index.htm", locals);

            // And responds to all customers with a set of data in data.
            io.sockets.emit("server-render", data);
        });
    });
};</code></pre><p>And for client-side, we use the following files:</p><p><em>assets/javascripts/index.js</em></p><pre><code class="language-js">var html = document.getElementsByTagName("html")[0],
    layout = document.getElementsByClassName("layout")[0];

// We associate on the button the action to contact server.
function setServerRender() {
    var button = document.getElementsByTagName("button")[0];
    button.addEventListener("click", function () {
        NA.socket.emit("server-render", {
            lang: html.getAttribute("lang")
        });
    });
}

// We set action on button.
setServerRender();

// When server response come back...
NA.socket.on("server-render", function (data) {

    // ...we update data content...
    layout.innerHTML = data.render;

    // ...and we set again button action.
    setServerRender();
});</code></pre><p>Run your project and go on <code>http://localhost/</code> across multiple tab and/or multiple browsers. You will see when you click on "Update", the page (current date) will be updated on all tabs open.</p><p>Thanks to <code>NA.specific</code>, <code>NA.common</code> and <code>NA.view</code>, it's possible to generate a new view and variation compilation.</p><p>If <code>data.lang</code> in this example is the type of <code>undefined</code>, files will be searched in the root directory. If <code>locals</code> is the type of <code>undefined</code> an empty object will be created.</p><p>Note: to allows <code>view</code> to use Pug template engine and not EJS, you must define <code>locals.pug</code> to <code>true</code> before use <code>NA.common</code> and <code>NA.specific</code>.</p><h3 id="middlewares">Middlewares</h3><p>NodeAtlas is constructed on the top of <a href="http://expressjs.com/">Express</a>. You can access to the Express Object of a NodeAtlas instance using <code>NA#express</code>. With this, you are able to add Express middlewares in the same way you add it in standalone Express.</p><p>What we can say about the NodeAtlas's Express pre-configuration when the webconfig is empty:</p><pre><code class="language-js">NA.express.set("strict routing", true);
/* ... */
NA.express.set("x-powered-by", false);
/* ... */
/* Activate gzip, deflate and co. */
NA.express.use(compress());
/* ... */
/* Parsing "x-www-form-urlencoded" encryption type. */
NA.express.use(bodyParser.urlencoded({ extended: true }));
/* ... */
/* Parsing "application/json" encryption type. */
NA.express.use(bodyParser.json());
/* ... */
/* Parsing cookies. */
NA.express.use(cookieParser());
/* ... */
/* Manage session cookies. */
NA.express.use(session(optionSession));
/* ... */
/* Manage `assets/` directory and access of file from domain root or a subpath. */
NA.express.use(NA.webconfig.urlRelativeSubPath, express.static(path.join(NA.serverPath, NA.webconfig.assetsRelativePath), staticOptions));</code></pre><p>You can add middlewares with different ways.</p><h4 id="with-setconfigurations">With <code>setConfigurations</code></h4><p>You can get the <code>NA#express</code> object ready to use middlewares with the <code>setConfigurations</code> hook. That will add the new mechanisms for all routes of your website.</p><pre><code class="language-js">exports.setConfigurations = function (next) {
    var NA = this;

    // Middleware create by you.
    NA.express.use(function (request, response, next) {
        response.setHeader("X-Frame-Options", "ALLOW-FROM https://www.lesieur.name/");
        next();
    });

    // Middleware adding severals security headers.
    NA.express.use(require("helmet")());

    next();
};</code></pre><h4 id="with-the-middlewares-parameter-from-routes">With the <code>middlewares</code> parameter from Routes</h4><p>It's also possible to deliver middlewares only for one route. In this case, you could use the <code>middlewares</code> parameter like this :</p><p><strong>webconfig.json</strong></p><pre><code class="language-js">{
    "middlewaresRelativePath": "middlewares",
    "routes": {
        "/upload-file": {
            "view": "upload.htm",
            "controller": "upload.js",
            "middlewares": "upload.js"
        }
    }
    "_jwt": {
        secret: "AUTH_CLIENT_SECRET",
        audience: "AUTH_CLIENT_ID"
    }
}</code></pre><p>and use the following file to authorize the <code>"multipart/data-form"</code> encryption data type by POST only if you are authenticated by a JSON token:</p><p><strong>middlewares/upload.js</strong></p><pre><code class="language-js">var multer  = require("multer"),
    jwt = require("express-jwt");

module.exports = function () {
    var NA = this,
        path = NA.modules.path,
        upload = multer({ dest: path.join(NA.serverPath, "uploads") });

    return [
        jwt({
            secret: NA.webconfig._jwt.secret,
            audience: NA.webconfig._jwt.audience
        }),
        upload.single("avatar"),
    ];
};</code></pre><p><em>Note: if</em> <code>middlewaresRelativePath</code> <em>is not present in <code>webconfig.json</code>, default controller folder is</em> <code>middlewares</code>. <code>middlewaresRelativePath</code> <em>is useful only to change the name/path of directory.</em></p><h4 id="with-the-middlewares-parameter-in-global">With the <code>middlewares</code> parameter in Global</h4><p>It's also possible to use the same way for all routes. So, the webconfig will be used like that:</p><p><strong>webconfig.json</strong></p><pre><code class="language-js">{
    "middlewares": "is-authenticated.js"
    "routes": {
        "/upload-file": {
            "view": "upload.htm",
            "controller": "upload.js"
        }
    }
    "_jwt": {
        secret: "AUTH_CLIENT_SECRET",
        audience: "AUTH_CLIENT_ID"
    }
}</code></pre><p>With the file:</p><p><strong>middlewares/is-authenticated.js</strong></p><pre><code class="language-js">var jwt = require("express-jwt");

module.exports = function () {
    var NA = this;

    return [
        jwt({
            secret: NA.webconfig._jwt.secret,
            audience: NA.webconfig._jwt.audience
        })
    ];
};</code></pre><h4 id="array-of-middlewares">Array of <code>middlewares</code></h4><p>You could also provide an array with a file list of Express middlewares both in local route or global:</p><p><strong>webconfig.json</strong></p><pre><code class="language-js">{
    "routes": {
        "/upload-file": {
            "view": "upload.htm",
            "controller": "upload.js",
            "middlewares": ["is-authenticated.js", "redirect.js"]
        }
    }
    "_jwt": {
        secret: "AUTH_CLIENT_SECRET",
        audience: "AUTH_CLIENT_ID"
    }
}</code></pre><p>With the <code>NA</code> usage:</p><p><strong>middlewares/is-authenticated.js</strong></p><pre><code class="language-js">var jwt = require("express-jwt");

module.exports = function () {
    var NA = this;

    return [jwt({
        secret: NA.webconfig._jwt.secret,
        audience: NA.webconfig._jwt.audience
    })];
};</code></pre><p>or not:</p><p><strong>middlewares/redirect.js</strong></p><pre><code class="language-js">module.exports = function (request, response, next) {

    response.redirect('https://go.to.visitor.page/');

    next();
};</code></pre><div><div class="before">
							<a href="view-part.html">◄ View Part</a>
						</div><div class="after">
							<a href="tools-part.html">Tools Part ►</a>
						</div></div>