<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>NodeAtlas by Haeresis</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>NodeAtlas</h1>
        <p>NodeAtlas vous permet de créer et maintenir des Assets HTML ou sites multilingues simplement en Node.js</p>

        <p class="view"><a href="https://github.com/Haeresis/NodeAtlas">View the Project on GitHub <small>Haeresis/NodeAtlas</small></a></p>


        <ul>
          <li><a href="https://github.com/Haeresis/NodeAtlas/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/Haeresis/NodeAtlas/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/Haeresis/NodeAtlas">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="node-atlas" class="anchor" href="#node-atlas"><span class="octicon octicon-link"></span></a>node-atlas</h1>

<p>Version : 0.14.6 (Beta)</p>

<h2>
<a name="avant-propos" class="anchor" href="#avant-propos"><span class="octicon octicon-link"></span></a>Avant-propos</h2>

<p>NodeAtlas est une application réalisée en JavaScript et tournant avec <a href="http://nodejs.org/">Node.js</a>. Elle permet trois choses :</p>

<ul>
<li>Créer et maintenir un ensemble d'assets HTML/CSS/JavaScript pour les fournir à des développeurs Back-end.</li>
<li>Créer et maintenir des sites multilingues sans Back-end.</li>
<li>Développer des sites ou des applications Node.js multilingues de toutes tailles.</li>
</ul><h3>
<a name="exemples-de-r%C3%A9alisations-avec-nodeatlas" class="anchor" href="#exemples-de-r%C3%A9alisations-avec-nodeatlas"><span class="octicon octicon-link"></span></a>Exemples de réalisations avec NodeAtlas</h3>

<p>L'outil est encore en développement et je l'expérimente petit à petit avec mes propres sites.</p>

<ul>
<li>Exemple de génération d'asset HTML (En cours...).</li>
<li>
<a href="https://github.com/Haeresis/ResumeAtlas/">Exemple de simple site Node.js sans Back-end</a>.</li>
<li>
<a href="https://github.com/Haeresis/BlogAtlas/">Exemple de développement de site Node.js</a>.</li>
</ul><h3>
<a name="table-des-mati%C3%A8res" class="anchor" href="#table-des-mati%C3%A8res"><span class="octicon octicon-link"></span></a>Table des matières</h3>

<ul>
<li>
<a href="#avant-propos">Avant-propos</a>

<ul>
<li><a href="#exemples-de-r%C3%A9alisations-avec-nodeatlas">Exemple de réalisations avec NodeAtlas</a></li>
<li><a href="#table-des-mati%C3%A8res">Table des matières</a></li>
<li><a href="#roadmap-davancement-du-d%C3%A9veloppement">Roadmap d'avancement du développement</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a></li>
<li>
<a href="#commencer-avec-nodeatlas">Commencer avec NodeAtlas</a>

<ul>
<li><a href="#ensemble-de-fichiers">Ensemble de fichiers</a></li>
<li><a href="#configuration-minimale">Configuration minimale</a></li>
<li><a href="#lancer-le-site-avec-nodeatlas">Lancer le site avec NodeAtlas</a></li>
</ul>
</li>
<li>
<a href="#diff%C3%A9rentes-configurations-du-webconfigjson">Différentes configurations du webconfig.json</a>

<ul>
<li><a href="#plusieurs-pages">Plusieurs pages</a></li>
<li><a href="#h%C3%A9berger-des-images-polices-css-js-etc">Héberger des images, polices, CSS, JS, etc.</a></li>
<li><a href="#g%C3%A9rer-des-inclusions-pour-%C3%A9viter-la-redondance-du-code">Gérer des inclusions pour éviter la redondance du code</a></li>
<li><a href="#g%C3%A9rer-des-variations-au-sein-dun-m%C3%AAme-template">Gérer des variations au sein d'un même template</a></li>
<li><a href="#utiliser-nodeatlas-pour-g%C3%A9n%C3%A9rer-des-assets-html">Utiliser NodeAtlas pour générer des assets HTML</a></li>
<li><a href="#utiliser-nodeatlas-pour-faire-tourner-un-site-partie-back-end">Utiliser NodeAtlas pour faire tourner un site (partie Back-end)</a></li>
<li><a href="#changer-les-param%C3%A8tres-durl">Changer les paramètres d'url.</a></li>
<li><a href="#cr%C3%A9er-ses-propres-variables-de-webconfig">Créer ses propres variables de webconfig</a></li>
<li><a href="#g%C3%A9rer-lurlrewriting">Gérer l'UrlRewriting</a></li>
<li><a href="#g%C3%A9rer-les-pages-inexistantes">Gérer les pages inexistantes</a></li>
<li><a href="#g%C3%A9rer-les-redirections">Gérer les redirections</a></li>
<li><a href="#autoriserinterdire-les-demandes-getpost">Autoriser/Interdire les demandes GET/POST</a></li>
<li><a href="#changer-les-chevrons---du-moteur-de-template">Changer les chevrons &lt;% %&gt; du moteur de template</a></li>
<li><a href="#changer-la-source-jquery-utilis%C3%A9e">Changer la source jQuery utilisée</a></li>
<li><a href="#changer-lurl-final-des-hostname-et-port-d%C3%A9coute">Changer l'url final des hostname et port d'écoute</a></li>
</ul>
</li>
<li>
<a href="#commandes-de-lancement">Commandes de lancement</a>

<ul>
<li><a href="#--directory">--directory</a></li>
<li><a href="#--webconfig">--webconfig</a></li>
<li><a href="#--run">--run</a></li>
<li><a href="#--httpport">--httpPort</a></li>
<li><a href="#--generate">--generate</a></li>
</ul>
</li>
<li><a href="#nodeatlas-comme-module-npm">NodeAtlas comme module npm</a></li>
<li>
<a href="#faire-tourner-nodeatlas-sur-server">Faire tourner NodeAtlas sur server</a>

<ul>
<li><a href="#dans-un-environnement-windows-server-avec-iisnode">Dans un environnement Windows Server avec iisnode</a></li>
<li><a href="#dans-un-environnement-unix-avec-forever">Dans un environnement Unix avec forever</a></li>
<li><a href="#proxy">Proxy</a></li>
</ul>
</li>
</ul><h3>
<a name="roadmap-davancement-du-d%C3%A9veloppement" class="anchor" href="#roadmap-davancement-du-d%C3%A9veloppement"><span class="octicon octicon-link"></span></a>Roadmap d'avancement du développement</h3>

<ul>
<li>
<p>Fait </p>

<ul>
<li>Lancement d'un serveur Express</li>
<li>Génération live de maquette HTML</li>
<li>Génération complète de maquette HTML</li>
<li>Fichier de configuration (Liste des pages avec Url Rewriting)</li>
<li>Partie Back-end possible (Controllers / Models) </li>
<li>Support de BDD possible (MySql / MongoDB)</li>
<li>Support de Socket.IO possible</li>
<li>Support des variables de parse Body / Cookie / Session</li>
<li>Support des variables personnelles de webconfig</li>
<li>Migration Express 3.x vers Express 4.x</li>
<li>Exemple de reverse-proxy pour plusieurs instances sur port 80</li>
<li>Lancer NodeAtlas avec un require() depuis un fichier de code.</li>
</ul>
</li>
<li>
<p>À venir </p>

<ul>
<li>Support d'une BDD de Session (ex: Redis) + key/secret</li>
<li>Support des modules Express possible</li>
<li>Auto Minification de Css/Js</li>
<li>Auto compression images</li>
<li>Injection automatique de feuille CSS en style inline (pour les maquettes email)</li>
<li>Agrégation de fichier CSS/JS pour les versions de site en production.</li>
<li>Auto-déploiement via transfert FTP</li>
<li>Support Sass/Less</li>
<li>...</li>
</ul>
</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Il y a plusieurs solutions pour installer Node-Atlas :</p>

<ol>
<li><p>Télécharger NodeAtlas depuis le site officiel <a href="https://haeresis.github.com/NodeAtlas/">NodeAtlas</a>.
<em>Une fois téléchargé, dézippez <strong>NodeAtlas</strong> dans le dossier qui vous conviendra.</em></p></li>
<li><p><code>npm install node-atlas</code>
<em>Ceci installera <strong>NodeAtlas</strong> dans le dossier <code>node_modules/node-atlas</code> du dossier d'execution de la commande.</em></p></li>
<li><p><code>npm install -g node-atlas</code>
<em>Ceci installera <strong>NodeAtlas</strong> dans le dossier <code>node_modules/node-atlas</code> global.</em></p></li>
<li><p>Cloner le répertoire depuis <a href="https://github.com/Haeresis/NodeAtlas/">GitHub</a>.
<em>Ceci installera <strong>NodeAtlas</strong> dans le dossier d'accueil du clonage.</em></p></li>
</ol><h2>
<a name="commencer-avec-nodeatlas" class="anchor" href="#commencer-avec-nodeatlas"><span class="octicon octicon-link"></span></a>Commencer avec NodeAtlas</h2>

<h3>
<a name="ensemble-de-fichiers" class="anchor" href="#ensemble-de-fichiers"><span class="octicon octicon-link"></span></a>Ensemble de fichiers</h3>

<p>Après avoir installé NodeAtlas quelque part sur votre machine, créez-vous un ensemble de fichiers représentant un site n'importe où ailleurs comme la structure ci-dessous.</p>

<pre><code>site-hello-world/
— templates/
—— index.htm
— webconfig.json
</code></pre>

<p>Voici le fichier « /site-hello-world/templates/index.htm » :</p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>Ceci est un Hello World !<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p>et ci-après, le fichier « /site-hello-world/webconfig.json ».</p>

<h3>
<a name="configuration-minimale" class="anchor" href="#configuration-minimale"><span class="octicon octicon-link"></span></a>Configuration minimale</h3>

<p>Vous pouvez faire tourner une page simple sans images ou fichiers CSS/JS hébergés par le site avec la configuration minimale du « webconfig.json » ci-dessous.</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>Note : vous pouvez inclure des images ou fichiers CSS/JS hébergés sur d'autres sites.</em></p>

<h3>
<a name="lancer-le-site-avec-nodeatlas" class="anchor" href="#lancer-le-site-avec-nodeatlas"><span class="octicon octicon-link"></span></a>Lancer le site avec NodeAtlas</h3>

<h4>
<a name="%C3%80-la-ligne-de-commande" class="anchor" href="#%C3%80-la-ligne-de-commande"><span class="octicon octicon-link"></span></a>À la ligne de commande</h4>

<p>Placez-vous avec un invité de commande dans le dossier « /site-hello-world/ » et exécutez la commande suivante.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js
</code></pre>

<p>À votre première exécution, NodeAtlas installera tous les « node_modules » nécessaires à son fonctionnement (si vous avez téléchargé hors npm).</p>

<p>Ré-exécutez.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js
</code></pre>

<p>Vous aurez alors accès à votre « Hello World » à la page : <em>http://localhost/</em> dans un navigateur.</p>

<h4>
<a name="via-un-fichier-javascript" class="anchor" href="#via-un-fichier-javascript"><span class="octicon octicon-link"></span></a>Via un fichier JavaScript</h4>

<p>Vous pouvez également utiliser NodeAtlas comme un module npm.</p>

<p><em>app.js</em></p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">nodeAtlas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"node-atlas"</span><span class="p">);</span>

<span class="nx">nodeAtlas</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
</pre></div>

<pre><code>\&gt; node app.js
</code></pre>

<h2>
<a name="diff%C3%A9rentes-configurations-du-webconfigjson" class="anchor" href="#diff%C3%A9rentes-configurations-du-webconfigjson"><span class="octicon octicon-link"></span></a>Différentes configurations du webconfig.json</h2>

<h3>
<a name="plusieurs-pages" class="anchor" href="#plusieurs-pages"><span class="octicon octicon-link"></span></a>Plusieurs pages</h3>

<p>Ci-dessous un exemple de configuration.</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/member.html"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"member.htm"</span>
            <span class="s2">"postSupport"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">"/member-without-extension/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"member.htm"</span>
            <span class="s2">"getSupport"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="p">},</span> 
        <span class="s2">"/error.html"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"error.htm"</span><span class="p">,</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">404</span><span class="p">,</span>
            <span class="s2">"mimeType"</span><span class="o">:</span> <span class="s2">"text/plain"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Pour faire tourner cet ensemble de fichier :</p>

<pre><code>templates/
— index.htm
— member.htm
— error.htm
webconfig.json
</code></pre>

<p>aux adresses :</p>

<ul>
<li>
<em>http://localhost/</em> (répond à la racine)</li>
<li>
<em>http://localhost/member.html</em> (ne répondra pas si demandée en POST)</li>
<li>
<em>http://localhost/member-without-extension/</em> (ne répondra pas si demandée en GET)</li>
<li>
<em>http://localhost/error.html</em> (renvoi du contenu plein texte (sans balise) avec une erreur 404)</li>
</ul><h3>
<a name="h%C3%A9berger-des-images-polices-css-js-etc" class="anchor" href="#h%C3%A9berger-des-images-polices-css-js-etc"><span class="octicon octicon-link"></span></a>Héberger des images, polices, CSS, JS, etc.</h3>

<p>Vous pouvez également héberger tout un tas de fichier sur votre site dans un dossier public. Par exemple avec cette configuration :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"assetsRelativePath"</span><span class="o">:</span> <span class="s2">"assets/"</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>et cet ensemble de fichiers :</p>

<pre><code>assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
— media/
—— images/
——— logo.png
templates/
— index.htm
webconfig.json
</code></pre>

<p>vous aurez accès aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/stylesheets/common.css</em></li>
<li><em>http://localhost/javascript/common.js</em></li>
<li><em>http://localhost/media/images/logo.png</em></li>
</ul><p><em>Note : Si</em> <strong><em>assetsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier public est bien</em> <strong><em>assets/</em></strong>. <strong><em>assetsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom du répertoire.</em></p>

<h3>
<a name="g%C3%A9rer-des-inclusions-pour-%C3%A9viter-la-redondance-du-code" class="anchor" href="#g%C3%A9rer-des-inclusions-pour-%C3%A9viter-la-redondance-du-code"><span class="octicon octicon-link"></span></a>Gérer des inclusions pour éviter la redondance du code</h3>

<p>Vous pouvez segmenter vos codes HTML afin de ne pas répéter le code redondant comme par exemple les parties « head » et « foot » ou tout autre fragment de code :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"componentsRelativePath"</span><span class="o">:</span> <span class="s2">"components/"</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>avec les fichiers suivants :</p>

<pre><code>assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
components/
— head.htm
— foot.htm
templates/
— index.htm
— members.htm
webconfig.json
</code></pre>

<p><em>components/head.htm</em></p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"stylesheets/common.css"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
</pre></div>

<p><em>components/foot.htm</em></p>

<div class="highlight highlight-html"><pre>        <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"javascript/common.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p><em>templates/index.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="err">&lt;</span>% include head.htm %&gt;

    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Bienvenue<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>C'est la page d'accueil.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="err">&lt;</span>% include foot.htm %&gt;
</pre></div>

<p><em>templates/members.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="err">&lt;</span>% include head.htm %&gt;

    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Liste des members<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>C'est la page des membres<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="err">&lt;</span>% include foot.htm %&gt;
</pre></div>

<p>vous aurez accès aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
</ul><p><em>Note : Si</em> <strong><em>componentsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des includes est bien</em> <strong><em>components/</em></strong>. <strong><em>componentsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom de répertoire.</em></p>

<h3>
<a name="g%C3%A9rer-des-variations-au-sein-dun-m%C3%AAme-template" class="anchor" href="#g%C3%A9rer-des-variations-au-sein-dun-m%C3%AAme-template"><span class="octicon octicon-link"></span></a>Gérer des variations au sein d'un même template</h3>

<h4>
<a name="en-standard" class="anchor" href="#en-standard"><span class="octicon octicon-link"></span></a>En standard</h4>

<p>Il est possible avec le même template et les mêmes includes de générer des pages au contenu différent (pratique en mode génération d'assets HTML). Activer les variations avec la configuration suivante :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"commonVariation"</span><span class="o">:</span> <span class="s2">"common.json"</span><span class="p">,</span>
    <span class="s2">"variationsRelativePath"</span><span class="o">:</span> <span class="s2">"variations/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"template.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"index.json"</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"template.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"members.json"</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>avec les fichiers suivants :</p>

<pre><code>assets/
— stylesheets/
—— common.css
—— home.css
—— members.css
— javascript/
—— common.js
—— home.js
—— members.js
components/
— head.htm
— foot.htm
variations/
— common.json
— index.json
— members.json
templates/
— template.htm
webconfig.json
</code></pre>

<p><em>components/head.htm</em></p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span><span class="err">&lt;</span>%= specific.titlePage %&gt;<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"stylesheets/&lt;%= common.classCssCommon %&gt;.css"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"stylesheets/&lt;%= specific.classPage %&gt;.css"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"&lt;%= specific.classPage %&gt;"</span><span class="nt">&gt;</span>
</pre></div>

<p><em>components/foot.htm</em></p>

<div class="highlight highlight-html"><pre>        <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"javascript/&lt;%= common.classJsCommon %&gt;.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p><em>templates/template.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="err">&lt;</span>% include head.htm %&gt;

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= common.titleWebsite %&gt;<span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;h1&gt;</span><span class="err">&lt;</span>%= specific.titlePage %&gt;<span class="nt">&lt;/h1&gt;</span>
        <span class="err">&lt;</span>%- specific.content %&gt;
    <span class="nt">&lt;/div&gt;</span>

    <span class="err">&lt;</span>% include foot.htm %&gt;
</pre></div>

<p><em>variations/common.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titleWebsite"</span><span class="o">:</span> <span class="s2">"Titre du site"</span><span class="p">,</span>
    <span class="s2">"classCssCommon"</span><span class="o">:</span> <span class="s2">"common"</span><span class="p">,</span>
    <span class="s2">"classJsCommon"</span><span class="o">:</span> <span class="s2">"common"</span>
<span class="p">}</span>
</pre></div>

<p><em>variations/index.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titlePage"</span><span class="o">:</span> <span class="s2">"Bienvenue"</span><span class="p">,</span>
    <span class="s2">"classPage"</span><span class="o">:</span> <span class="s2">"index"</span><span class="p">,</span>
    <span class="s2">"content"</span><span class="o">:</span> <span class="s2">"&lt;p&gt;C'est la page d'accueil.&lt;/p&gt;"</span>
<span class="p">}</span>
</pre></div>

<p><em>variations/members.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titlePage"</span><span class="o">:</span> <span class="s2">"Liste des members"</span><span class="p">,</span>
    <span class="s2">"classPage"</span><span class="o">:</span> <span class="s2">"members"</span><span class="p">,</span>
    <span class="s2">"content"</span><span class="o">:</span> <span class="s2">"&lt;p&gt;C'est la page des membres&lt;/p&gt;"</span>
<span class="p">}</span>
</pre></div>

<p>vous aurez accès aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
</ul><p><em>Note : Si</em> <strong><em>variationsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des variations est bien</em> <strong><em>variations/</em></strong>. <strong><em>variationsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom de répertoire.</em></p>

<h4>
<a name="pour-le-multilingue" class="anchor" href="#pour-le-multilingue"><span class="octicon octicon-link"></span></a>Pour le multilingue</h4>

<h5>
<a name="toutes-les-langues-sur-le-m%C3%AAme-site" class="anchor" href="#toutes-les-langues-sur-le-m%C3%AAme-site"><span class="octicon octicon-link"></span></a>Toutes les langues sur le même site</h5>

<p>Sur le même principe, les variations peuvent être utilisées pour créer la même page, mais dans des langues différentes :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"en-gb"</span><span class="p">,</span>
    <span class="s2">"variationsRelativePath"</span><span class="o">:</span> <span class="s2">"languages/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"landing.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"landing.json"</span>
        <span class="p">},</span>
        <span class="s2">"/home/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"home.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"home.json"</span>
        <span class="p">},</span>
        <span class="s2">"/accueil/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"home.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"home.json"</span><span class="p">,</span>
            <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"fr-fr"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>Note : Dans cet exemple j'ai décidé de me passer d'un fichier de variation commune, car je n'ai pas précisé de</em> <strong><em>commonVariation</em></strong>. <em>J'ai également totalement arbitrairement décidé de renommer mon dossier</em> <strong><em>variations/</em></strong> <em>en</em> <strong><em>languages/</em></strong>.</p>

<p>avec les fichiers suivants :</p>

<pre><code>components/
— head.htm
— foot.htm
languages/
— en-gb
—— landing.json
—— home.json
— fr-fr
—— home.json
templates/
— landing.htm
— home.htm
webconfig.json
</code></pre>

<p><em>components/head.htm</em></p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"&lt;%= languageCode %&gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span><span class="err">&lt;</span>%= specific.titlePage %&gt;<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"&lt;%= specific.classPage %&gt;"</span><span class="nt">&gt;</span>
</pre></div>

<p><em>components/foot.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p><em>templates/landing.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="err">&lt;</span>% include head.htm %&gt;

    <span class="nt">&lt;select&gt;</span>
        <span class="err">&lt;</span>% for (var i = 0; i <span class="nt">&lt; specific.selectLabel.length</span><span class="err">;</span> <span class="na">i</span><span class="err">++)</span> <span class="err">{</span> <span class="err">%</span><span class="nt">&gt;</span>
        <span class="nt">&lt;option&gt;</span><span class="err">&lt;</span>%= specific.selectLabel[i] %&gt;<span class="nt">&lt;/option&gt;</span>
        <span class="err">&lt;</span>% } %&gt;
    <span class="nt">&lt;/select&gt;</span>

    <span class="err">&lt;</span>% include foot.htm %&gt;
</pre></div>

<p><em>templates/home.htm</em></p>

<div class="highlight highlight-html"><pre>    <span class="err">&lt;</span>% include head.htm %&gt;

    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;h1&gt;</span><span class="err">&lt;</span>%= specific.titlePage %&gt;<span class="nt">&lt;/h1&gt;</span>
        <span class="err">&lt;</span>%- specific.content %&gt;
    <span class="nt">&lt;/div&gt;</span>

    <span class="err">&lt;</span>% include foot.htm %&gt;
</pre></div>

<p><em>languages/en-gb/landing.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titlePage"</span><span class="o">:</span> <span class="s2">"Landing"</span><span class="p">,</span>
    <span class="s2">"classPage"</span><span class="o">:</span> <span class="s2">"landing"</span><span class="p">,</span>
    <span class="s2">"selectLabel"</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">"English"</span><span class="p">,</span>
        <span class="s2">"Français"</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p><em>languages/en-gb/home.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titlePage"</span><span class="o">:</span> <span class="s2">"Welcome"</span><span class="p">,</span>
    <span class="s2">"classPage"</span><span class="o">:</span> <span class="s2">"home"</span><span class="p">,</span>
    <span class="s2">"content"</span><span class="o">:</span> <span class="s2">"&lt;p&gt;This is a home page.&lt;/p&gt;"</span>
<span class="p">}</span>
</pre></div>

<p><em>languages/fr-fr/home.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"titlePage"</span><span class="o">:</span> <span class="s2">"Bienvenue"</span><span class="p">,</span>
    <span class="s2">"classPage"</span><span class="o">:</span> <span class="s2">"home"</span><span class="p">,</span>
    <span class="s2">"content"</span><span class="o">:</span> <span class="s2">"&lt;p&gt;C'est la page d'accueil.&lt;/p&gt;"</span>
<span class="p">}</span>
</pre></div>

<p>vous aurez accès aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/home/</em></li>
<li><em>http://localhost/accueil/</em></li>
</ul><p><em>Note : Par défaut c'est le</em> <strong><em>languageCode</em></strong> <em>racine qui conditionne la langue d'affichage du site. Cependant, spécifiquement par page on peut changer la langue avec également le</em> <strong><em>languageCode*</em></strong>. <em>Il faut également savoir que dès que le site ou une page à un</em> <strong><em>languageCode</em></strong> <em>dans la configuration, ses fichiers de variations doivent être placées dans un sous répertoire portant le nom du</em> <strong><em>languageCode</em></strong>.</p>

<h5>
<a name="a-chaque-langue-sa-configuration" class="anchor" href="#a-chaque-langue-sa-configuration"><span class="octicon octicon-link"></span></a>A chaque langue sa configuration</h5>

<p>Vous pouvez également décider de faire tourner chaque langue dans un « webconfig.json » différent. Avec l'ensemble de fichier suivant :</p>

<pre><code>components/
— head.htm
— foot.htm
variations/
— en-gb
—— landing.json
—— home.json
—— members.json
— fr-fr
—— home.json
—— members.json
templates/
— landing.htm
— home.htm
— members.htm
webconfig.json
webconfig.en-gb.json
webconfig.fr-fr.json
</code></pre>

<p>vous pourriez avoir les « webconfig.json » suivant :</p>

<p><em>webconfig.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"en-gb"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"landing.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"landing.json"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>webconfig.en-gb.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">81</span><span class="p">,</span>
    <span class="s2">"urlRelativeSubPath"</span><span class="o">:</span> <span class="s2">"/english"</span><span class="p">,</span>
    <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"en-gb"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"home.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"home.json"</span>
        <span class="p">},</span> 
        <span class="s2">"/members-list/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"members.json"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>webconfig.fr-fr.json</em></p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">82</span><span class="p">,</span>
    <span class="s2">"urlRelativeSubPath"</span><span class="o">:</span> <span class="s2">"/francais"</span><span class="p">,</span>
    <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"fr-fr"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"home.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"home.json"</span>
        <span class="p">},</span> 
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"members.json"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>et avoir accès aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost:81/english/</em></li>
<li><em>http://localhost:81/english/</em></li>
<li><em>http://localhost:81/english/members-list/</em></li>
<li><em>http://localhost:82/francais/</em></li>
<li><em>http://localhost:82/francais/liste-des-membres/</em></li>
</ul><p><em>Note : il est possible de faire ensuite du reverse proxy pour ramener l'ensemble des urls sur les ports autres que le port 80 sur le port 80.</em></p>

<h3>
<a name="utiliser-nodeatlas-pour-g%C3%A9n%C3%A9rer-des-assets-html" class="anchor" href="#utiliser-nodeatlas-pour-g%C3%A9n%C3%A9rer-des-assets-html"><span class="octicon octicon-link"></span></a>Utiliser NodeAtlas pour générer des assets HTML</h3>

<h4>
<a name="g%C3%A9n%C3%A9rer-des-assets-html" class="anchor" href="#g%C3%A9n%C3%A9rer-des-assets-html"><span class="octicon octicon-link"></span></a>Générer des assets HTML</h4>

<p>Avec la configuration suivante il est possible de générer des assets HTML du rendu de chaque page dans un fichier associé. Le fichier sera (re)créé à chaque affichage de la page dans votre navigateur.</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"autoGenerate"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"generatesRelativePath"</span><span class="o">:</span> <span class="s2">"generate/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span><span class="p">,</span>
            <span class="s2">"generate"</span><span class="o">:</span> <span class="s2">"/index.html"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"generate"</span><span class="o">:</span> <span class="s2">"/members/list.html"</span>
        <span class="p">},</span>
        <span class="s2">"/no/generate/property/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>et l'ensemble de fichiers suivant :</p>

<pre><code>{
assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
generate/
templates/
— index.htm
— members.htm
webconfig.json
}
</code></pre>

<p>on peut créer physiquement les assets :</p>

<pre><code>{
generate/
— index.html
— members/
—— list.html
— no/
—— generate/
——— property &lt;== Ceci est un fichier
templates/
— index.htm
— members.htm
webconfig.json
}
</code></pre>

<p>en se rendant aux adresses :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
</ul><p>La génération s'enclenche quand on affiche la page uniquement parce que <strong><em>autoGenerate</em></strong> existe et est à <strong><em>true</em></strong>. S'il est passé à <strong><em>false</em></strong> (ou enlevé) le seul moyen de générer toutes les pages du site sera via la commande <code>node &lt;/path/to/&gt;node-atlas/server.js --generate</code> qui génèrera toutes les pages d'un coup. Bien entendu dans tous les cas cette commande marche et permet de régénérer toutes les pages suite à un changement telle qu'une modification dans un composant appelé sur toutes les pages.</p>

<p><em>Note : Si</em> <strong><em>generatesRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des générations est bien</em> <strong><em>generatesRelativePath/</em></strong>. <strong><em>generatesRelativePath</em></strong> <em>est donc utile seulement pour changer le nom répertoire.</em></p>

<h4>
<a name="g%C3%A9n%C3%A9rer-un-site-sans-partie-serveur" class="anchor" href="#g%C3%A9n%C3%A9rer-un-site-sans-partie-serveur"><span class="octicon octicon-link"></span></a>Générer un site sans partie serveur</h4>

<p>Il est également possible de manager la création d'un site en simple page HTML avec la configuration suivante :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"fr-fr"</span><span class="p">,</span>
    <span class="s2">"indexPage"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"autoGenerate"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"generatesRelativePath"</span><span class="o">:</span> <span class="s2">"../HTML/"</span><span class="p">,</span>
    <span class="s2">"assetsRelativePath"</span><span class="o">:</span> <span class="s2">"../HTML/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/cv.html"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"index.json"</span>
        <span class="p">},</span>
        <span class="s2">"/en/cv.html"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"index.json"</span><span class="p">,</span>
            <span class="s2">"languageCode"</span><span class="o">:</span> <span class="s2">"en"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>et l'ensemble de fichiers suivant :</p>

<pre><code>HTML/
— stylesheets/
—— common.css
— javascript/
—— common.js
engine/
— variations/
—— fr-fr/
——— index.json
—— en/
——— index.json
— templates/
—— index.htm
— webconfig.json
</code></pre>

<p>À l'adresse <em>http://localhost/</em> s'affichera la liste des pages composants votre site (grâce à <strong>indexPage</strong> à <strong>true</strong>).</p>

<p>Il ne restera plus qu'à, une fois votre travail terminé, admirer votre site HTML dans le dossier :</p>

<pre><code>HTML/
— stylesheets/
—— common.css
— javascript/
—— common.js
— cv.html
— en/
—— cv.html
</code></pre>

<h3>
<a name="utiliser-nodeatlas-pour-faire-tourner-un-site-partie-back-end" class="anchor" href="#utiliser-nodeatlas-pour-faire-tourner-un-site-partie-back-end"><span class="octicon octicon-link"></span></a>Utiliser NodeAtlas pour faire tourner un site (partie Back-end)</h3>

<p>Vous pouvez soit utiliser un contrôleur unique pour tout le site et/ou également des contrôleurs par template et variation.</p>

<p>Pour le contrôleur maître, utilisez par exemple cette configuration :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"commonController"</span><span class="o">:</span> <span class="s2">"common.js"</span><span class="p">,</span>
    <span class="s2">"controllersRelativePath"</span><span class="o">:</span> <span class="s2">"controllers/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"index.json"</span>
        <span class="p">},</span>
        <span class="s2">"/categories/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"categories.htm"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"categories.json"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>avec cet ensemble de fichier</p>

<pre><code>variations/
— index.json
— categories.json
controllers/
— common.js
models/
— Article.js
— Category.js
templates/
— index.htm
— categories.htm
webconfig.json
</code></pre>

<p>Et le fichier « common.js » contenant par exemple :</p>

<ul>
<li>De quoi charger des modules supplémentaires à NodeAtlas.</li>
<li>De quoi configurer les modules supplémentaires.</li>
</ul><div class="highlight highlight-js"><pre><span class="c1">// Création d'un objet global au fichier.</span>
<span class="kd">var</span> <span class="nx">website</span> <span class="o">=</span> <span class="p">{};</span>



<span class="cm">/**********************/</span>
<span class="cm">/* Chargement modules */</span>
<span class="cm">/**********************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="c1">// Chargement des modules pour ce site dans l'objet NodeAtlas.</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">loadModules</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">NA</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Gestion de l'accès aux modules s'il ne sont pas dans « node_modules ».</span>
        <span class="kd">var</span> <span class="nx">modulePath</span> <span class="o">=</span> <span class="p">(</span><span class="nx">NA</span><span class="p">.</span><span class="nx">webconfig</span><span class="p">.</span><span class="nx">_needModulePath</span><span class="p">)</span> <span class="o">?</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">nodeModulesPath</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>

        <span class="c1">// Associations de chaque module pour y avoir accès partout.</span>
        <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">modulePath</span> <span class="o">+</span> <span class="s1">'connect'</span><span class="p">);</span>
        <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">modulePath</span> <span class="o">+</span> <span class="s1">'cookie'</span><span class="p">);</span>
        <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">modulePath</span> <span class="o">+</span> <span class="s1">'mongoose'</span><span class="p">);</span>
        <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">socketio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">modulePath</span> <span class="o">+</span> <span class="s1">'socket.io'</span><span class="p">);</span>

        <span class="c1">// Ré-injection de l'objet « NodeAtlas » surchargé dans le moteur.</span>
        <span class="k">return</span> <span class="nx">NA</span><span class="p">;</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">));</span>



<span class="cm">/*****************************/</span>
<span class="cm">/* Configuration des modules */</span>
<span class="cm">/*****************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">privates</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// Exemple d'utilisation de MongoDB et Mongoose.</span>
    <span class="nx">privates</span><span class="p">.</span><span class="nx">mongooseInitialization</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mongoose</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Connexion à la base « blog ».</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://127.0.0.1:27017/blog'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="c1">// Suite.</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">mongoose</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">// Gestion de connexion.</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Mongoose default connection error: '</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">// Gestion des déconnexion.</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'disconnected'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Mongoose default connection disconnected'</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'SIGINT'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Mongoose default connection disconnected through app termination'</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="c1">// Mise à disposition des Schémas Mongoose.</span>
    <span class="nx">privates</span><span class="p">.</span><span class="nx">mongooseShemas</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mongoose</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">publics</span><span class="p">.</span><span class="nx">shemas</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="c1">// Chargement des Schémas.</span>
        <span class="nx">publics</span><span class="p">.</span><span class="nx">shemas</span><span class="p">.</span><span class="nx">article</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/Article'</span><span class="p">);</span>
        <span class="nx">publics</span><span class="p">.</span><span class="nx">shemas</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/Category'</span><span class="p">);</span>

        <span class="c1">// Mise à disposition des Schémas.</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'article'</span><span class="p">,</span> <span class="nx">website</span><span class="p">.</span><span class="nx">shemas</span><span class="p">.</span><span class="nx">article</span><span class="p">,</span> <span class="s1">'article'</span><span class="p">);</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'category'</span><span class="p">,</span> <span class="nx">website</span><span class="p">.</span><span class="nx">shemas</span><span class="p">.</span><span class="nx">category</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="c1">// Exemple d'utilisation de Socket.IO.</span>
    <span class="nx">privates</span><span class="p">.</span><span class="nx">socketIoInitialisation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socketio</span><span class="p">,</span> <span class="nx">NA</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">socketio</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">NA</span><span class="p">.</span><span class="nx">server</span><span class="p">),</span>
            <span class="nx">connect</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">connect</span><span class="p">,</span>
            <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>

        <span class="c1">// Synchronisation des Sessions avec Socket.IO.</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'authorization'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Fallback si les cookies ne sont pas gérés.</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">accept</span><span class="p">(</span><span class="s1">'Session cookie required.'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Transformation du cookie en Objet cookie.</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>

            <span class="c1">// Vérification de la signature du cookie.</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseSignedCookies</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">,</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">webconfig</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">secret</span><span class="p">);</span>

            <span class="c1">// Sauver nous même une copie de la Session.</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="nx">NA</span><span class="p">.</span><span class="nx">webconfig</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span>

            <span class="c1">// Accepter le cookie.</span>
            <span class="nx">NA</span><span class="p">.</span><span class="nx">webconfig</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionStore</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">||</span> <span class="o">!</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">accept</span><span class="p">(</span><span class="s2">"Error"</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
                    <span class="nx">accept</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>

        <span class="p">});</span>

        <span class="c1">// Suite.</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">io</span><span class="p">);</span>       
    <span class="p">};</span>

    <span class="c1">// Ajout d'évênements d'écoute pour un controller spécifique « index.js » (voir exemple dans le fichier d'après).</span>
    <span class="nx">privates</span><span class="p">.</span><span class="nx">socketIoEvents</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">NA</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">params</span><span class="p">.</span><span class="nx">io</span> <span class="o">=</span> <span class="nx">io</span><span class="p">;</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">NA</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">;</span>

        <span class="c1">// Évênements pour la page article (voir exemple dans le fichier d'après).</span>
        <span class="nx">require</span><span class="p">(</span><span class="s1">'./index'</span><span class="p">).</span><span class="nx">asynchrone</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="c1">// Configuration de tous les modules</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">setConfigurations</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">NA</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">mongoose</span><span class="p">,</span>
            <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">socketio</span><span class="p">,</span>
            <span class="nx">connect</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">connect</span><span class="p">;</span>

        <span class="c1">// Initialisation de Mongoose.</span>
        <span class="nx">privates</span><span class="p">.</span><span class="nx">mongooseInitialization</span><span class="p">(</span><span class="nx">mongoose</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mongoose</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Injection de Schémas dans Mongoose.</span>
            <span class="nx">privates</span><span class="p">.</span><span class="nx">mongooseShemas</span><span class="p">(</span><span class="nx">mongoose</span><span class="p">);</span>

            <span class="c1">// Initialisation de Socket IO.</span>
            <span class="nx">privates</span><span class="p">.</span><span class="nx">socketIoInitialisation</span><span class="p">(</span><span class="nx">socketio</span><span class="p">,</span> <span class="nx">NA</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">io</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">// Écoute d'action Socket IO.</span>
                <span class="nx">privates</span><span class="p">.</span><span class="nx">socketIoEvents</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">NA</span><span class="p">);</span>

                <span class="c1">// Ré-injection do l'objet « NodeAtlas » surchargé dans le moteur.</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">NA</span><span class="p">);</span>                   
            <span class="p">});</span>
        <span class="p">});</span>

    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">));</span>



<span class="cm">/*******************************/</span>
<span class="cm">/* Interception des Variations */</span>
<span class="cm">/*******************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="c1">// On intervient juste avant l'assemblage complet EJS.</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">variation</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">variation</span><span class="p">;</span>

        <span class="c1">// Ici on modifie les variables de variations.</span>
        <span class="c1">// voir exemple dans le fichier d'après.</span>

        <span class="c1">// On ré-injecte les modifications.</span>
        <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">variation</span><span class="p">);</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">));</span>



<span class="cm">/**********************************************************/</span>
<span class="cm">/* Interception dela sortie HTML pour jQuery côté serveur */</span>
<span class="cm">/**********************************************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="c1">// On intervient juste avant le renvoi HTML auprès du client (response).</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

        <span class="c1">// Ici on peut manipuler le DOM côté serveur avant retour client.</span>
        <span class="c1">// voir exemple dans le fichier d'après.</span>

        <span class="c1">// On ré-injecte les modifications.</span>
        <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">));</span>



<span class="cm">/**************************************************************/</span>
<span class="cm">/* Mise à dispositions des fonctionr pour le moteur NodeAtlas */</span>
<span class="cm">/**************************************************************/</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">loadModules</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">loadModules</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">setConfigurations</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">setConfigurations</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">preRender</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">render</span><span class="p">;</span>
</pre></div>

<p>Au lieu de se servir de preRender et render dans le fichier common.js effectif pour tout le site, on peut utiliser des contrôleurs spécifiques par page. La configuration précédente devient alors :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"commonController"</span><span class="o">:</span> <span class="s2">"common.js"</span><span class="p">,</span>
    <span class="s2">"controllersRelativePath"</span><span class="o">:</span> <span class="s2">"controllers/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span><span class="p">,</span>
            <span class="s2">"controller"</span><span class="o">:</span> <span class="s2">"index.js"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"index.json"</span>
        <span class="p">},</span>
        <span class="s2">"/categories/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"categories.htm"</span><span class="p">,</span>
            <span class="s2">"controller"</span><span class="o">:</span> <span class="s2">"categories.js"</span><span class="p">,</span>
            <span class="s2">"variation"</span><span class="o">:</span> <span class="s2">"categories.json"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>avec cet ensemble de fichier</p>

<pre><code>variations/
— index.json
— categories.json
controllers/
— modules/
—— list-of-article.js/
— common.js
- index.js
- categories.js
models/
— Article.js
— Category.js
templates/
— index.htm
— categories.htm
webconfig.json
</code></pre>

<p>avec un fichier « index.js » contenant par exemple :</p>

<ul>
<li>De quoi modifier les variations dynamiquement avant affichage.</li>
<li>De quoi faire des modifications jQuery côté serveur.</li>
<li>De quoi faire des échanges asynchrones avec Socket.IO.</li>
</ul><div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">website</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">website</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="p">{};</span>



<span class="cm">/*******************************/</span>
<span class="cm">/* Interception des Variations */</span>
<span class="cm">/*******************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">privates</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// On charge une fonction ou un ensemble de fonctions.</span>
    <span class="nx">privates</span><span class="p">.</span><span class="nx">listOfArticles</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./modules/list-of-articles'</span><span class="p">);</span>

    <span class="c1">// On intervient juste avant l'assemblage complet EJS.</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">variation</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">variation</span><span class="p">,</span>
            <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">mongoose</span><span class="p">,</span>
            <span class="nx">Article</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'article'</span><span class="p">);</span>


        <span class="c1">// Interception possible de toutes les variables de « variation/common.js ».</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">common</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span> <span class="c1">// Renvoi le titre stocké dans « variation/common.js ».</span>
        <span class="nx">variation</span><span class="p">.</span><span class="nx">common</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">"Nouveau title"</span><span class="p">;</span> <span class="c1">// Redéfini un titre.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">common</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span> <span class="c1">// Renvoi « Nouveau title » et est accessible côté template via « &lt;%= common.title ». </span>

        <span class="c1">// Interception possible de toutes les variables de « variation/index.js » (car on est dans le spécific « index.js »).</span>
        <span class="nx">variation</span><span class="p">.</span><span class="nx">specific</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">"Nouveau title"</span><span class="p">;</span> <span class="c1">// Redéfini un titre qui est accessible côté template via « &lt;%= specific.title ».</span>
        <span class="nx">variation</span><span class="p">.</span><span class="nx">specific</span><span class="p">.</span><span class="nx">newProperty</span> <span class="o">=</span> <span class="s2">"Nouvelle propriété"</span><span class="p">;</span> <span class="c1">// Défini une propriété n'existant pas initialement dans le fichier de variation qui est accessible côté template via « &lt;%= specific.newProperty ».</span>

        <span class="c1">// Interception possible de la configuration de la page courante.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">pageUrlRewriting</span><span class="p">)</span> <span class="c1">// Retourne « / » pour « index », « /categories/ » pour categories, etc.</span>
        <span class="k">if</span> <span class="p">(</span><span class="cm">/* test de non existance */</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">variation</span><span class="p">.</span><span class="nx">pageParameters</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span> <span class="c1">// La page sera en 404.</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">variation</span><span class="p">.</span><span class="nx">pageParameters</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="c1">// La page sera en 200.</span>
        <span class="p">}</span>

        <span class="c1">// Création d'un nouvel ensemble de variation dynamique pour les templates.</span>
        <span class="nx">variation</span><span class="p">.</span><span class="nx">backend</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// Accessible via « &lt;%= backend.&lt;propriétés&gt; %&gt; ».</span>

        <span class="nx">privates</span><span class="p">.</span><span class="nx">listOfArticles</span><span class="p">(</span><span class="nx">Article</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">listOfArticles</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Disponibilité des données des articles côté template derrière</span>
            <span class="nx">variation</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nx">articles</span> <span class="o">=</span> <span class="nx">listOfArticles</span><span class="p">;</span> <span class="c1">// « &lt;%= backend.articles.&lt;propriétés&gt; %&gt; ».</span>

            <span class="c1">// On ré-injecte les modifications.</span>
            <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">variation</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">));</span>



<span class="cm">/***********************************************************/</span>
<span class="cm">/* Interception de la sortie HTML pour jQuery côté serveur */</span>
<span class="cm">/***********************************************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="c1">// On intervient juste avant le renvoi HTML auprès du client (response).</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
            <span class="nx">NA</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">NA</span><span class="p">,</span>
            <span class="nx">jsdom</span> <span class="o">=</span> <span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">jsdom</span><span class="p">;</span> <span class="c1">// Récupération de jsdom pour parcourir le DOM avec jQuery.</span>

        <span class="c1">// On charge le fichier jQuery défini dans le moteur, mais on peut utiliser une autre version.</span>
        <span class="nx">jsdom</span><span class="p">.</span><span class="nx">env</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">[</span><span class="nx">NA</span><span class="p">.</span><span class="nx">webconfig</span><span class="p">.</span><span class="nx">jQueryVersion</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">$</span><span class="p">;</span>

            <span class="c1">// Après tous les h2 de la sortie HTML « data »,</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">"h2"</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

                <span class="c1">// ... on créé une div,</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span>
                    <span class="c1">// ... on injecte le contenu du h2 dans la div,</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"&lt;div&gt;"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">html</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="c1">// ... et supprime le h2.</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="c1">// On re-créer une nouvelle sortie HTML avec nos modifications.</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">doctype</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;script class=.jsdom.+&gt;&lt;\/script&gt;&lt;\/html&gt;/g</span><span class="p">,</span> <span class="s2">"&lt;/html&gt;"</span><span class="p">);</span> <span class="c1">// (Si vous connaissez un moyen plus élégant d'enlever ce script ajouté automatiquement « &lt;script class=.jsdom.+&gt;&lt;\/script&gt;&lt;\/html&gt; », faites moi signe !)</span>

            <span class="c1">// On ré-injecte les modifications.</span>
            <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">));</span>



<span class="cm">/***********************************************/</span>
<span class="cm">/* Gestion des évênements Socket.IO asynchrone */</span>
<span class="cm">/***********************************************/</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">publics</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">privates</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// Intégralité des actions Websocket possible pour ce template.</span>
    <span class="nx">publics</span><span class="p">.</span><span class="nx">asynchrone</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">io</span><span class="p">,</span>
            <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">mongoose</span><span class="p">,</span>
            <span class="nx">marked</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">NA</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">marked</span><span class="p">,</span>
            <span class="nx">Article</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'article'</span><span class="p">),</span>
            <span class="nx">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">marked</span><span class="p">.</span><span class="nx">Renderer</span><span class="p">();</span>

        <span class="c1">// Dès qu'on a un lien valide entre le client et notre back,</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connection'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span>
                <span class="nx">session</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>

            <span class="c1">// ... resté à l'écoute de la demande « create-article-button »,</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'create-article-button'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">// ... et répondre à cette demande en créant un nouvelle article si elle vient</span>
                <span class="c1">// avec les information envoyées via « data ».</span>
                <span class="kd">var</span> <span class="nx">article</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Article</span><span class="p">({</span>
                    <span class="nx">_id</span><span class="o">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">(),</span>
                    <span class="nx">title</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                    <span class="nx">urn</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">urn</span><span class="p">,</span>
                <span class="p">});</span>

                <span class="c1">// Si l'utilisateur est connecté.</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">account</span><span class="p">)</span> <span class="p">{</span>

                    <span class="err">/ ... on créer sauve article en base.</span>
                    <span class="nx">article</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> 
                            <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="c1">// Et on répond à tous les clients avec un jeu de donnée dans data.</span>
                        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'create-article-button'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>

<span class="p">}(</span><span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">));</span>



<span class="cm">/***********************************************************/</span>
<span class="cm">/* Interception de la sortie HTML pour jQuery côté serveur */</span>
<span class="cm">/***********************************************************/</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">preRender</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">render</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">asynchrone</span> <span class="o">=</span> <span class="nx">website</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">asynchrone</span><span class="p">;</span> <span class="c1">// Utilisé non pas par « NodeAtlas » mais par « common.js » (voir fichier précédent).</span>
</pre></div>

<p><em>Note : Si</em> <strong><em>controllersRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js » alors toute la partie Back-end est désactivée.</em></p>

<h3>
<a name="changer-les-param%C3%A8tres-durl" class="anchor" href="#changer-les-param%C3%A8tres-durl"><span class="octicon octicon-link"></span></a>Changer les paramètres d'url</h3>

<p>Par défaut, si vous utilisez la configuration suivante :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>cela est identique à utiliser celle-ci :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"httpHostname"</span><span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"httpSecure"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s2">"urlRelativeSubPath"</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>et vous pourrez accéder à l'url : <em>http://localhost/</em>.</p>

<p>Changez alors la configuration en ceci :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"httpHostname"</span><span class="o">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">7777</span><span class="p">,</span>
    <span class="s2">"httpSecure"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"urlRelativeSubPath"</span><span class="o">:</span> <span class="s2">"/sub/folder"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>pour accéder à : <em><a href="https://127.0.0.1:7777/sub/folder/">https://127.0.0.1:7777/sub/folder/</a></em></p>

<h3>
<a name="cr%C3%A9er-ses-propres-variables-de-webconfig" class="anchor" href="#cr%C3%A9er-ses-propres-variables-de-webconfig"><span class="octicon octicon-link"></span></a>Créer ses propres variables de webconfig</h3>

<p>Imaginons deux webconfigs dans lesquels nous allons créer nos propres variables comme suit :</p>

<ol>
<li>« webconfig.json »</li>
</ol><div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">},</span> 
    <span class="s2">"_minified"</span><span class="o">:</span> <span class="s2">""</span>
<span class="p">}</span>
</pre></div>

<ol>
<li>« webconfig.prod.json »</li>
</ol><div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">},</span> 
    <span class="s2">"_minified"</span><span class="o">:</span> <span class="s2">".min"</span>
<span class="p">}</span>
</pre></div>

<p>avec cet ensemble de fichiers</p>

<pre><code>assets/
— stylesheets/
—— common.css
—— common.min.css
— javascript/
—— common.js
—— common.min.js
templates/
— index.htm
webconfig.json
webconfig.prod.json
</code></pre>

<p>et « index.htm » contenant :</p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"stylesheets/common&lt;%= webconfig._minified %&gt;.css"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>Ceci est un test de récupération de ressources minifiées/non-minifiées.<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"javascript/common&lt;%= webconfig._minified %&gt;.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p>En lançant (depuis le dossier du site) la commande :</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js
</code></pre>

<p>Nous aurons à l'adresse « http://localhost/ » la sortie suivante avec les fichiers non minifiés :</p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"stylesheets/common.css"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>Ceci est un test de récupération de ressources minifiées/non-minifiées.<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"javascript/common.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p>Cependant en lançant la commande :</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/server.js --webconfig webconfig.prod.json 
</code></pre>

<p>Nous aurons à l'adresse « http://localhost/ » la sortie suivante avec les fichiers minifiés :</p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr-fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"stylesheets/common.min.css"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>Ceci est un test de récupération de ressources minifiées/non-minifiées.<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"javascript/common.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p><em>Note : Il vaut mieux préfixer ses variables personnelles avec « _ » pour éviter des conflits avec des variables de configuration existantes ou futures.</em></p>

<h3>
<a name="g%C3%A9rer-lurlrewriting" class="anchor" href="#g%C3%A9rer-lurlrewriting"><span class="octicon octicon-link"></span></a>Gérer l'UrlRewriting</h3>

<p>Bien que vous puissiez paramétrer des urls statiques, vous pouvez également paramétrer une écoute d'url dynamique !</p>

<h4>
<a name="standard" class="anchor" href="#standard"><span class="octicon octicon-link"></span></a>Standard</h4>

<p>Avec la configuration suivante :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/liste-des-membres/:member/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>vous pourrez accéder à :</p>

<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
<li><em>http://localhost/liste-des-membres/toto/</em></li>
<li><em>http://localhost/liste-des-membres/bob-eponge99/</em></li>
<li><em>http://localhost/liste-des-membres/node-atlas/</em></li>
<li><em>http://localhost/liste-des-membres/etc/</em></li>
</ul><p>et récupérer les valeurs de <code>:member</code> dans le <code>preRender</code> (common et specific).</p>

<div class="highlight highlight-js"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">variation</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">variation</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">member</span><span class="p">);</span> 
    <span class="c1">// \&gt; 'toto', 'bob-eponge99', 'node-atlas' ou 'etc'.</span>

    <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">variation</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Les règles de création d'url dynamique sont celles de <a href="http://expressjs.com/4x/api.html#req.params">Express.js</a>.</p>

<h4>
<a name="expressions-r%C3%A9guli%C3%A8res" class="anchor" href="#expressions-r%C3%A9guli%C3%A8res"><span class="octicon octicon-link"></span></a>Expressions Régulières</h4>

<p>Vous pouvez également activer les expressions régulières pour un chemin précis avec <code>regExp</code>. Si celui-ci vaut <code>true</code>, le précédent mode ne fonctionne plus et vous passez en mode Expression Régulière. Si <code>regExp</code> est une chaine de caractère, celle-ci fait office de flag (g, i, m ou y).</p>

<p>Voyez la configuration suivante :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/liste-des-membres/([-a-z0-9]+)/?"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"regExp"</span><span class="o">:</span> <span class="s2">"g"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/?"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"regExp"</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>vous pourrez accéder à :</p>

<ul>
<li><em>http://localhost/</em></li>
<li>
<em>http://localhost/liste-des-membres/</em> <em>(ou <em>https://localhost/liste-des-membres</em>)</em>
</li>
<li>
<em>http://localhost/liste-des-membres/toto/</em> <em>(ou <em>https://localhost/liste-des-membres/toto</em>)</em>
</li>
<li>
<em>http://localhost/liste-des-membres/bob-eponge99/</em> <em>(ou <em>https://localhost/liste-des-membres/bob-eponge99</em>)</em>
</li>
<li>
<em>http://localhost/liste-des-membres/node-atlas/</em> <em>(ou <em>https://localhost/liste-des-membres/node-atlas</em>)</em>
</li>
<li>
<em>http://localhost/liste-des-membres/etc/</em> <em>(ou <em>https://localhost/liste-des-membres/etc</em>)</em>
</li>
</ul><p>et récupérer les valeurs de <code>([-a-z0-9]+)</code> dans le <code>preRender</code> (common et specific).</p>

<div class="highlight highlight-js"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">preRender</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">mainCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">variation</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">variation</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">variation</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span> <span class="nx">variation</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">member</span> <span class="o">=</span> <span class="nx">variation</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>
    <span class="c1">// variation.params[1] pour le deuxième match, etc...</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">variation</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">member</span><span class="p">);</span> 
    <span class="c1">// \&gt; 'toto', 'bob-eponge99', 'node-atlas' ou 'etc'.</span>

    <span class="nx">mainCallback</span><span class="p">(</span><span class="nx">variation</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Les règles de création d'url dynamique avec <code>regExp</code> sont celles des <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp">RegExp JavaScript</a>.</p>

<h3>
<a name="g%C3%A9rer-les-pages-inexistantes" class="anchor" href="#g%C3%A9rer-les-pages-inexistantes"><span class="octicon octicon-link"></span></a>Gérer les pages inexistantes</h3>

<p>Pour afficher une page personnalisée quand une ressource n'est pas trouvée il faut :</p>

<ol>
<li>Préparer une page 404.</li>
<li>Remplir le paramètre <code>pageNotFound</code> avec comme <code>value</code> la <code>key</code> de la page 404 préparée.</li>
</ol><p>Voyez l'exemple ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"pageNotFound"</span><span class="o">:</span> <span class="s2">"/pages-inexistantes/"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/pages-inexistantes/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"error.htm"</span><span class="p">,</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">404</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>vous pourrez accéder à :</p>

<ul>
<li><em>http://localhost/cette-page-n-existe-pas.html</em></li>
<li><em>http://localhost/elle/non/plus/</em></li>
<li><em>http://localhost/etc</em></li>
</ul><h3>
<a name="g%C3%A9rer-les-redirections" class="anchor" href="#g%C3%A9rer-les-redirections"><span class="octicon octicon-link"></span></a>Gérer les redirections</h3>

<p>Pour aller à une autre adresse (redirection 301 ou 302) quand vous arrivez à une url il faut utiliser le paramètre <code>redirect</code>.</p>

<h4>
<a name="en-statique" class="anchor" href="#en-statique"><span class="octicon octicon-link"></span></a>En statique</h4>

<p>Voyez l'exemple ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"redirect"</span><span class="o">:</span> <span class="s2">"/liste-des-membres/"</span><span class="p">,</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">301</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">"/aller-sur-node-atlas/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"redirect"</span><span class="o">:</span> <span class="s2">"http://haeresis.github.io/NodeAtlas/"</span><span class="p">,</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">302</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Vous serez redirigé :</p>

<ul>
<li>sur <code>http://localhost/liste-des-membres/</code> quand vous accéderez à <code>http://localhost/liste-des-membres</code> avec une entête <em>redirection permanente</em>.</li>
<li>sur <code>http://haeresis.github.io/NodeAtlas/</code> quand vous accéderez à <code>http://localhost/aller-sur-node-atlas/</code> avec une entête <em>redirection temporaire</em>.</li>
</ul><h4>
<a name="en-dynamique" class="anchor" href="#en-dynamique"><span class="octicon octicon-link"></span></a>En dynamique</h4>

<p>Voyez l'exemple ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/liste-des-membres/:member/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/:member"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"redirect"</span><span class="o">:</span> <span class="s2">"/membres/:member/"</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">301</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Vous serez redirigé sur <code>http://localhost/liste-des-membres/haeresis/</code> quand vous accéderez à <code>http://localhost/liste-des-membres/haeresis</code> avec une entête <em>redirection permanente</em>.</p>

<h4>
<a name="avec-expressions-r%C3%A9guli%C3%A8res" class="anchor" href="#avec-expressions-r%C3%A9guli%C3%A8res"><span class="octicon octicon-link"></span></a>Avec expressions régulières</h4>

<p>Voyez l'exemple ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/membres/([-a-z0-9]+)/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span><span class="p">,</span>
            <span class="s2">"regExp"</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/([-a-z0-9]+)/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"redirect"</span><span class="o">:</span> <span class="s2">"/membres/$0$/"</span>
            <span class="s2">"statusCode"</span><span class="o">:</span> <span class="mi">301</span><span class="p">,</span>
            <span class="s2">"regExp"</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Vous serez redirigé sur <code>http://localhost/membres/haeresis/</code> quand vous accéderez à <code>http://localhost/liste-des-membres/haeresis/</code> avec une entête <em>redirection permanente</em>.</p>

<p>Pour le second <em>match</em> utilisez $1$, pour le troisième $2$, etc.</p>

<h3>
<a name="autoriserinterdire-les-demandes-getpost" class="anchor" href="#autoriserinterdire-les-demandes-getpost"><span class="octicon octicon-link"></span></a>Autoriser/Interdire les demandes GET/POST</h3>

<p>Vous pouvez également manager la manière dont le serveur va répondre aux demandes GET/POST pour une page donnée. Par exemple, nous allons autoriser l'accès aux pages uniquement en GET pour tout le site et autoriser un POST pour une page seulement (et même lui interdire le GET).</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"getSupport"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"postSupport"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/liste-des-membres/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"members.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/rediger-commentaire/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"write-com.htm"</span>
        <span class="p">},</span>
        <span class="s2">"/commentaire-sauvegarde/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"save-com.htm"</span><span class="p">,</span>
            <span class="s2">"getSupport"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s2">"postSupport"</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>Note : Si rien n'est précisé,</em> <strong><em>getSupport</em></strong> <em>et</em> <strong><em>postSupport</em></strong> <em>sont à</em> <strong><em>true</em></strong> <em>au niveau global et par page.</em></p>

<h3>
<a name="changer-les-chevrons---du-moteur-de-template" class="anchor" href="#changer-les-chevrons---du-moteur-de-template"><span class="octicon octicon-link"></span></a>Changer les chevrons &lt;% %&gt; du moteur de template</h3>

<p>Par exemple, pour inclure une partie de fichier on utilise l'instruction <strong><em>&lt;% include head.htm %&gt;</em></strong>. Il serait possible de le faire avec <strong><em>{{ include head.htm }}</em></strong> avec la configuration ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"templateEngineOpenPattern"</span><span class="o">:</span> <span class="s2">"{{"</span><span class="p">,</span>
    <span class="s2">"templateEngineClosePattern"</span><span class="o">:</span> <span class="s2">"}}"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><em>Note : Si rien n'est précisé,</em> <strong><em>templateEngineOpenPattern</em></strong> <em>et</em> <strong><em>templateEngineClosePattern</em></strong> <em>valent respectivement</em> <strong><em>&lt;%</em></strong> <em>et</em> <strong><em>%&gt;</em></strong>.</p>

<h3>
<a name="changer-la-source-jquery-utilis%C3%A9e" class="anchor" href="#changer-la-source-jquery-utilis%C3%A9e"><span class="octicon octicon-link"></span></a>Changer la source jQuery utilisée</h3>

<p>NodeAtlas utilise par défaut le fichier externe « <a href="http://code.jquery.com/jquery.js">http://code.jquery.com/jquery.js</a> » pour manipuler le DOM. Vous pouvez changer celui-ci avec cette configuration :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"jQueryVersion"</span><span class="o">:</span> <span class="s2">"./assets/javascript/jquery-1.9.0.js"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h3>
<a name="changer-lurl-final-des-hostname-et-port-d%C3%A9coute" class="anchor" href="#changer-lurl-final-des-hostname-et-port-d%C3%A9coute"><span class="octicon octicon-link"></span></a>Changer l'url final des hostname et port d'écoute</h3>

<p>Il est possible de générer une url de visite différente des paramètres d'écoutes demandés avec <strong><em>urlHostname</em></strong> et <strong><em>urlPort</em></strong>. Par exemple on écoute la boucle local sur le port 80 car un script fait du Reverse Proxy depuis le port 7777 sur le 80 avec le module « http-proxy » comme ci-dessous :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">7777</span><span class="p">,</span>
    <span class="s2">"httpHostname"</span><span class="o">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="s2">"urlPort"</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"urlHostname"</span><span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"template"</span><span class="o">:</span> <span class="s2">"index.htm"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="commandes-de-lancement" class="anchor" href="#commandes-de-lancement"><span class="octicon octicon-link"></span></a>Commandes de lancement</h2>

<p>La façon la plus simple de lancer NodeAtlas est de se positionner dans le répertoire hébergeant votre site et de lancer la commande <code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js</code>. Cependant il existe des options de lancement pour faire bien plus que lancer le site.</p>

<p>Chacune des commandes qui vont suivre peut être couplée avec les autres de cette manière :</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --directory /hello-world/  --webconfig config.fr-fr.js --httpPort 80 --run
</code></pre>

<h3>
<a name="--directory" class="anchor" href="#--directory"><span class="octicon octicon-link"></span></a>--directory</h3>

<p>Il est possible de lancer NodeAtlas depuis un autre endroit que le dossier où est hébergé le site que vous souhaitez faire tourner. La commande <code>--directory</code> vous sera alors très utile.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --directory &lt;/path/to/your/website/directory/&gt;
</code></pre>

<h3>
<a name="--webconfig" class="anchor" href="#--webconfig"><span class="octicon octicon-link"></span></a>--webconfig</h3>

<p>Par défaut, NodeAtlas va lire votre fichier <code>webconfig.json</code>. Il est possible qu'en plus de ce fichier vous ayez créé un autre fichier <code>webconfig.prod.json</code> dont le nom de domaine est différent. Ou encore un <code>webconfig.fr-fr.json</code> avec des urls et des variations dans une autre langue. Plutôt que de renommer vos fichiers en <code>webconfig.json</code> avant de lancer le site, précisez simplement votre autre nom de configuration. Dans l'exemple suivant, notre fichier sera <code>webconfig.alternatif.json</code>.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --webconfig webconfig.alternatif.json
</code></pre>

<h3>
<a name="--run" class="anchor" href="#--run"><span class="octicon octicon-link"></span></a>--run</h3>

<p>Cette commande permet d'ouvrir votre navigateur à l'adresse sur laquelle le site va tourner. Très pratique quand vous ne vous souvenez plus du port pour votre version de développement. Cette commande ne sert à rien si elle est couplé avec <code>--generate</code> (voir plus loin).</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --run
</code></pre>

<h3>
<a name="--httpport" class="anchor" href="#--httpport"><span class="octicon octicon-link"></span></a>--httpPort</h3>

<p>Vous n'allez peut être pas vous ennuyer à changer votre port d'écoute sur tous vos projets et parfois vous allez devoir travailler sur deux sites différents en même temps. Avec cette commande vous n'aurez pas besoin de couper vos sites alternativement pour libérer le port d'écoute, il suffira d'en choisir un au lancement.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --httpPort 7778
</code></pre>

<h3>
<a name="--generate" class="anchor" href="#--generate"><span class="octicon octicon-link"></span></a>--generate</h3>

<p>Si vous modifiez un élément dans votre fichier de variation commun ou même dans un de vos composants de template appelé sur plusieurs pages, vous n'allez pas recharger chaque page pour mettre à jour vos fichiers de sortie. Il suffira alors d'utiliser <code>--generate</code>.</p>

<pre><code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js --generate
</code></pre>

<h2>
<a name="nodeatlas-comme-module-npm" class="anchor" href="#nodeatlas-comme-module-npm"><span class="octicon octicon-link"></span></a>NodeAtlas comme module npm</h2>

<p>Si vous lancez NodeAtlas via du code JavaScript, vous pouvez également configurer le lancement :</p>

<p><em>app.js</em></p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">nodeAtlas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"node-atlas"</span><span class="p">);</span>

<span class="nx">nodeAtlas</span>
    <span class="p">.</span><span class="nx">config</span><span class="p">({</span>
        <span class="nx">directory</span><span class="o">:</span> <span class="s2">"&lt;/path/to/your/website/directory/&gt;"</span><span class="p">,</span>
        <span class="nx">webconfig</span><span class="o">:</span> <span class="s2">"webconfig.alternatif.json"</span><span class="p">,</span>
        <span class="nx">run</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">httpPort</span><span class="o">:</span> <span class="mi">7778</span><span class="p">,</span>
        <span class="nx">generate</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">init</span><span class="p">();</span>
</pre></div>

<pre><code>\&gt; node app.js
</code></pre>

<h2>
<a name="faire-tourner-nodeatlas-sur-serveur" class="anchor" href="#faire-tourner-nodeatlas-sur-serveur"><span class="octicon octicon-link"></span></a>Faire tourner NodeAtlas sur serveur</h2>

<h3>
<a name="dans-un-environnement-windows-server-avec-iisnode" class="anchor" href="#dans-un-environnement-windows-server-avec-iisnode"><span class="octicon octicon-link"></span></a>Dans un environnement Windows Server avec iisnode</h3>

<p>Dans un environnement Windows Server 2013 avec IIS8 il faut :</p>

<ol>
<li>Installer l’<a href="http://nodejs.org/download/">exécutable node.exe</a> capable d’exécuter du code JavaScript.</li>
<li>Installer <a href="http://www.iis.net/downloads/microsoft/url-rewrite">le module IIS8 UrlRewrite</a> pour mapper les pages exécutées à une Url de sortie.</li>
<li>Installer <a href="https://github.com/tjanczuk/iisnode/downloads">le module IIS8 issnode</a> pour lire des web.config et manager des site via IIS (Management de pool d’application, démarrage/arrêt de site, etc...).</li>
</ol><h4>
<a name="cr%C3%A9er-une-application" class="anchor" href="#cr%C3%A9er-une-application"><span class="octicon octicon-link"></span></a>Créer une application</h4>

<p>Dans IIS8, créez un Website et créez une Application.</p>

<p>Le contenu de votre application sera celui du site mélangé à celui de NodeAtlas. Cela signifie donc que ceci :</p>

<pre><code>node-atlas/
— node_modules/
— languages/
—— default.json
— node-atlas.js
site-hello-world/
— assets/
— templates/
—— index.htm
— webconfig.json
</code></pre>

<p>devient ceci :</p>

<pre><code>site-hello-world/
— node_modules/
— languages/
—— default.json
— assets/
— templates/
—— index.htm
— node-atlas.js
— webconfig.json
</code></pre>

<p>Vous rajouterez à cet ensemble de fichiers, un fichier supplémentaire nommé <code>web.config</code> dont le contenu est le suivant :</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;system.webServer&gt;</span>
        <span class="nt">&lt;handlers&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"iisnode"</span> <span class="na">path=</span><span class="s">"node-atlas.js"</span> <span class="na">verb=</span><span class="s">"*"</span> <span class="na">modules=</span><span class="s">"iisnode"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/handlers&gt;</span>
        <span class="nt">&lt;rewrite&gt;</span>
            <span class="nt">&lt;rules&gt;</span>
                <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"LogFile"</span> <span class="na">patternSyntax=</span><span class="s">"ECMAScript"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"^[a-zA-Z0-9_\-]+\.js\.logs\/\d+\.txt$"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/rule&gt;</span>
                <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"NodeInspector"</span> <span class="na">patternSyntax=</span><span class="s">"ECMAScript"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>                    
                    <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"^node-atlas.js\/debug[\/]?"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/rule&gt;</span>
                <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"StaticContent"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Rewrite"</span> <span class="na">url=</span><span class="s">"assets{REQUEST_URI}"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/rule&gt;</span>
                <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"DynamicContent"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;conditions&gt;</span>
                          <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{REQUEST_FILENAME}"</span> <span class="na">matchType=</span><span class="s">"IsFile"</span> <span class="na">negate=</span><span class="s">"True"</span><span class="nt">/&gt;</span>
                     <span class="nt">&lt;/conditions&gt;</span>
                     <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Rewrite"</span> <span class="na">url=</span><span class="s">"node-atlas.js"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/rule&gt;</span>
            <span class="nt">&lt;/rules&gt;</span>
        <span class="nt">&lt;/rewrite&gt;</span>

    <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>

<p>pour au final obtenir :</p>

<pre><code>site-hello-world/
— node_modules/
— languages/
—— default.json
— assets/
— templates/
—— index.htm
— node-atlas.js
— webconfig.json
— web.config
</code></pre>

<p>Il ne vous restera plus qu'à cliquer sur « Browse  » dans votre panneau d'action IIS8. Vous pouvez dès lors manager votre site (Démarrage / Arrêt / Recyclage de Pool) comme pour n'importe quelle autre application IIS8.</p>

<h4>
<a name="webconfig-exemple" class="anchor" href="#webconfig-exemple"><span class="octicon octicon-link"></span></a>webconfig exemple</h4>

<p>Un webconfig exemple pour une production :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlPort"</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">7777</span><span class="p">,</span>
    <span class="s2">"httpHostname"</span><span class="o">:</span> <span class="s2">"www.example.fr"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div>

<h3>
<a name="dans-un-environnement-unix-avec-forever" class="anchor" href="#dans-un-environnement-unix-avec-forever"><span class="octicon octicon-link"></span></a>Dans un environnement Unix avec forever</h3>

<p>Il faut pour cela :</p>

<ol>
<li>Installer l’<a href="http://nodejs.org/download/">exécutable node.exe</a> capable d’exécuter du code JavaScript.</li>
<li>Installer le <a href="https://github.com/nodejitsu/forever">CLI tool forever</a> pour manager vos sites en continue.</li>
<li>Faire tourner en plus de vos sites un reverse-proxy pour que toutes vos applications tournent sur le port 80.</li>
</ol><h4>
<a name="quelques-commandes-forever" class="anchor" href="#quelques-commandes-forever"><span class="octicon octicon-link"></span></a>Quelques commandes forever</h4>

<p>Pous lancer un site en continue il faut utiliser la commande :</p>

<pre><code>\&gt; forever start &lt;/path/to/&gt;node-atlas/node-atlas.js --directory &lt;/path/to/your/website/directory/&gt;
</code></pre>

<p>Pour le stopper, il faut repérer son <strong>uid</strong> avec la commande <code>forever list</code> puis utiliser la commande :</p>

<pre><code>\&gt; forever stop &lt;uid&gt;
</code></pre>

<p>ou  est l'<strong>uid</strong> du site qui tourne.</p>

<h4>
<a name="webconfig-exemple-1" class="anchor" href="#webconfig-exemple-1"><span class="octicon octicon-link"></span></a>webconfig exemple</h4>

<p>Un webconfig exemple pour une production :</p>

<div class="highlight highlight-js"><pre><span class="p">{</span>
    <span class="s2">"urlPort"</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"httpPort"</span><span class="o">:</span> <span class="mi">7777</span><span class="p">,</span>
    <span class="s2">"httpHostname"</span><span class="o">:</span> <span class="s2">"www.example.fr"</span><span class="p">,</span>
    <span class="s2">"urlRewriting"</span><span class="o">:</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div>

<p>Il vous faudra ensuite utiliser un reverse-proxy pour rendre votre site accessible sur le port 80.</p>

<h3>
<a name="proxy" class="anchor" href="#proxy"><span class="octicon octicon-link"></span></a>Proxy</h3>

<h4>
<a name="bouncy" class="anchor" href="#bouncy"><span class="octicon octicon-link"></span></a>Bouncy</h4>

<p>Bouncy est un exemple de reverse-proxy que vous pouvez utiliser pour faire tourner divers sites NodeAtlas (avec d'autres types de site) ensemble sur le même port (le 80).</p>

<p>Vous pouvez par exemple :</p>

<ul>
<li>lancer 3 applications Node.js sur les ports 7777, 7778 et 7779 avec forever,</li>
<li>et en plus lancer un server apache sur le port 81 </li>
</ul><p>et rendre tous vos sites accessibles derrière des noms de domaines sur le port 80 avec Bouncy par exemple.</p>

<p>Voici un exemple de configuration avec Bouncy :</p>

<p><strong>global-server.js</strong></p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">bouncy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bouncy'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">bouncy</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">bounce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'beep.example.com'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounce</span><span class="p">(</span><span class="mi">7777</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'blup.example.com'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounce</span><span class="p">(</span><span class="mi">7776</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'boop.example.com'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounce</span><span class="p">(</span><span class="mi">81</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'no such host'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
</pre></div>

<p>que vous pouvez lancer avec :</p>

<pre><code>\&gt; forever start &lt;/path/to/&gt;global-server.js
</code></pre>

<p><a href="https://github.com/substack/bouncy">Plus d'informations sur Bouncy</a></p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/Haeresis">Haeresis</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-50163044-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>