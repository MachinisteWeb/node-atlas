<h2 id="partie-controleur-et-modele">Partie Contrôleur et Modèle</h2><p>NodeAtlas ne se contente pas uniquement de faciliter la génération de page web en fonction de variable dans les fichiers de variation. NodeAtlas vous permet également d&#39;intéragir avec le contenu des fichiers variations ou avec le DOM généré en fonction ;</p><ul>
<li>des paramètres dans la partie query de l&#39;URL (GET),</li>
<li>des paramètres dans le body de la requête (POST),</li>
<li>de vous connecter à des bases de données,</li>
<li>de maintenir des sessions, </li>
<li>de faire des échanges Websockets et</li>
<li>de faire bien plus encore !</li>
</ul><h3 id="cycle-de-vie-et-points-d-entree">Cycle de vie et Points d&#39;entrée</h3><p>Le cycle de vie de NodeAtlas est le suivant. D&#39;abord, une et une seule fois, les ressources ce charge, le serveur démarre, les routes s&#39;initialise et tout est opérationnel. Puis, à chaque requête HTTP entrante, une réponse est générée. Vous pouvez intervenir grâce à différents points d&#39;entrée pendant le démarrage, et pendant la création d&#39;une page.</p><p>Voici à quoi peut ressembler un <code>webconfig.json</code> permettant d&#39;atteindre tous les points du cycle de vie d&#39;une page.</p><pre><code class="lang-json">{
    &quot;controllersRelativePath&quot;: &quot;controllers&quot;,
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.json&quot;
        }
    }
}
</code></pre><p><em>Note : Si</em> <strong><em>controllersRelativePath</em></strong> <em>n&#39;est pas présent dans « webconfig.json », par défaut le dossier des contrôleurs est bien</em> <strong><em>controllers</em></strong>. <strong><em>controllersRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin du répertoire.</em></p><p>et voici le détail des endroits ou vous pouvez intervenir :</p><p><em>Démarrage de NodeAtlas</em></p><p>Initialisation des modules</p><blockquote>
<ul>
<li><em>setModules</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</li>
</ul>
</blockquote><p>Initialisation des Sessions</p><blockquote>
<ul>
<li><em>setSessions</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</li>
</ul>
</blockquote><p>Initialisation des Sockets</p><blockquote>
<ul>
<li><em>setSockets</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</li>
<li><em>setSockets</em> --&gt; à manipuler depuis le fichier <code>routes[&lt;route&gt;].controller</code> (<code>index.js</code> dans l&#39;exemple).</li>
</ul>
</blockquote><p>Initialisation de la configuration du serveur</p><blockquote>
<ul>
<li><em>setConfigurations</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</li>
</ul>
</blockquote><p>Initialisation des routes</p><blockquote>
<ul>
<li><em>setRoutes</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</li>
</ul>
</blockquote><p>Lancement du serveur web</p><p><em>Requête/Réponse HTTP de NodeAtlas</em></p><p>Traitement de la Requête du Client</p><blockquote>
<ul>
<li><p><em>changeVariation</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</p>
</li>
<li><p><em>changeVariation</em> --&gt; à manipuler depuis le fichier <code>routes[&lt;route&gt;].controller</code> (<code>index.js</code> dans l&#39;exemple).</p>
</li>
</ul>
</blockquote><p>Assemblage des Vues et Compilation des Variations =&gt; DOM complet de la Réponse.</p><blockquote>
<ul>
<li><p><em>changeDom</em> --&gt; à manipuler depuis le fichier <code>commonController</code> (<code>common.js</code> dans l&#39;exemple).</p>
</li>
<li><p><em>changeDom</em> --&gt; à manipuler depuis le fichier <code>routes[&lt;route&gt;].controller</code> (<code>index.js</code> dans l&#39;exemple).</p>
</li>
</ul>
</blockquote><p>Envoi de la Réponse au Client</p><h4 id="changevariation">changeVariation</h4><p>Pour intercepter les variations, vous pouvez soit utiliser le contrôleur commun pour tout le site et/ou également le contrôleur par page.</p><p>Voici un exemple utilisant les deux points d&#39;entrée, d&#39;abord la commune à plusieurs pages, puis celle de chaque page :</p><pre><code class="lang-json">{
    &quot;urlRelativeSubPath&quot;: &quot;example&quot;,
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>avec cet ensemble de fichier :</p><pre><code>├─ variations/
│  ├─ common.json
│  └─ index.json
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  ├─ partials/
│  │  ├─ head.htm
│  │  └─ foot.htm
│  └─ index.htm
└─ webconfig.json
</code></pre><p>En demandant la page <code>http://localhost/example/?title=Haeresis</code> en POST avec une variable <code>example=Ceci+est+un+test</code> dans le corps de requête, les fichiers suivants (entre autre) seront utilisés :</p><p><em>variations/common.json</em></p><pre><code class="lang-json">{
    &quot;titleWebsite&quot;: &quot;Titre du site&quot;
}
</code></pre><p><em>variations/index.json</em></p><pre><code class="lang-json">{
    &quot;titlePage&quot;: &quot;Bienvenue&quot;,
    &quot;content&quot;: &quot;&lt;p&gt;C&#39;est la page d&#39;accueil.&lt;/p&gt;&quot;
}
</code></pre><p><em>views/index.htm</em></p><pre><code class="lang-html">    &lt;?- include(&quot;partials/head.htm&quot;) ?&gt;

    &lt;div class=&quot;title&quot;&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;

    &lt;div&gt;
        &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
        &lt;?- specific.content ?&gt;
    &lt;/div&gt;

    &lt;?- include(&quot;partials/foot.htm&quot;) ?&gt;
</code></pre><p><em>controllers/common.js</em></p><pre><code class="lang-json">// On intervient avant que les variables soient injectées dans le moteur de template.
// Ce code sera exécuté pour toute requête HTTP, toute page confondue.
exports.changeVariation = function (params, next) {
    var variation = params.variation,
        request = params.request,
        response = params.response;

    // Ici on modifie les variables de variations.

    console.log(variation.common.titleWebsite); // &quot;Titre du site&quot;
    console.log(variation.specific.titlePage); // &quot;Bienvenue&quot;
    console.log(variation.specific.content); // &quot;C&#39;est la page d&#39;accueil.&quot;

    console.log(&quot;urlRootPath&quot;, variation.urlRootPath); // &quot;http://localhost&quot;
    console.log(&quot;urlSubPath&quot;, variation.urlSubPath); // &quot;/example&quot;
    console.log(&quot;urlBasePath&quot;, variation.urlBasePath); // &quot;http://localhost/example&quot;
    console.log(&quot;urlFilePath&quot;, variation.urlFilePath); // &quot;/&quot;
    console.log(&quot;urlQueryPath&quot;, variation.urlQueryPath); // &quot;?title=Haeresis&quot;
    console.log(&quot;urlPath&quot;, variation.urlPath); // &quot;http://localhost/example/?title=Haeresis&quot;

    if (request.query[&quot;title&quot;]) {
        variation.specific.titlePage = variation.specific.titlePage + &quot; &quot; + request.query.title;
    }
    if (request.body[&quot;example&quot;]) {
        variation.specific.content = request.body.example;
    }

    console.log(variation.common.titleWebsite); // &quot;Titre du site&quot;
    console.log(variation.specific.titlePage); // &quot;Bienvenue Haeresis&quot;
    console.log(variation.specific.content); // &quot;Ceci est un test&quot;

    // On ré-injecte les modifications.
    next(variation);
};
</code></pre><p><em>controllers/index.js</em></p><pre><code class="lang-json">// On intervient avant que les variables soient injectées dans le moteur de template.
// Ce code sera exécuté uniquement lors de la demande de la page « / ».
exports.changeVariation = function (params, next) {
    var variation = params.variation,
        request = params.request,
        response = params.response;

    // Ici on modifie les variables de variations.

    console.log(variation.common.titleWebsite); // &quot;Titre du site&quot;
    console.log(variation.specific.titlePage); // &quot;Bienvenue Haeresis&quot;
    console.log(variation.specific.content); // &quot;Ceci est un test&quot;

    variation.common.titleWebsite = &quot;C&#39;est l&#39;accueil, c&#39;est tout.&quot;;
    variation.specific.content = &quot;C&#39;est l&#39;accueil, c&#39;est tout.&quot;;

    console.log(variation.common.titleWebsite); // &quot;C&#39;est l&#39;accueil, c&#39;est tout.&quot;
    console.log(variation.specific.titlePage); // &quot;Bienvenue Haeresis&quot;
    console.log(variation.specific.content); // &quot;C&#39;est l&#39;accueil, c&#39;est tout.&quot;

    // On ré-injecte les modifications.
    next(variation);
};
</code></pre><p>ce qui produit la sortie suivante :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;C&#39;est l&#39;accueil, c&#39;est tout.&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;C&#39;est l&#39;accueil, c&#39;est tout.&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Bienvenue Haeresis&lt;/h1&gt;
            C&#39;est l&#39;accueil, c&#39;est tout.
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>Si vous décidez de désabonner la variation spécifique avec le webconfig suivant :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        }
    }
}
</code></pre><p>alors la sortie sera :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;Titre du site&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;Titre du site&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Bienvenue Haeresis&lt;/h1&gt;
            Ceci est un test
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><h4 id="changedom">changeDom</h4><p>Pour intercepter le DOM avant qu&#39;il ne soit renvoyé, vous pouvez soit utiliser le contrôleur commun pour tout le site et/ou également le contrôleur par page.</p><p>Voici un exemple utilisant les deux points d&#39;entrée, d&#39;abord la commune à plusieurs pages, puis celle de chaque page :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>avec cet ensemble de fichier :</p><pre><code>├─ variations/
│  ├─ common.json
│  └─ index.json
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json
</code></pre><p>En demandant la page <code>http://localhost/</code> les fichiers suivants (entre autre) seront utilisés :</p><p><em>variations/common.json</em></p><pre><code class="lang-json">{
    &quot;titleWebsite&quot;: &quot;Titre du site&quot;
}
</code></pre><p><em>variations/index.json</em></p><pre><code class="lang-json">{
    &quot;titlePage&quot;: &quot;Bienvenue&quot;,
    &quot;content&quot;: &quot;&lt;p&gt;C&#39;est la page d&#39;accueil.&lt;/p&gt;&quot;
}
</code></pre><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;?- specific.content ?&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>controllers/common.js</em></p><pre><code class="lang-json">// On intervient avant que le DOM ne soit renvoyé au Client.
// Ce code sera exécuté pour toute requête HTTP, toute page confondue.
exports.changeDom = function (params, next) {
    var NA = this,
        dom = params.dom,
        request = params.request,
        response = params.response,
        cheerio = NA.modules.cheerio, // Récupération de jsdom pour parcourir le DOM avec jQuery.
        $ = cheerio.load(dom, { decodeEntities: false }); // On charge les données pour les manipuler comme un DOM.

    // Après tous les h1 de la sortie HTML « dom »,
    $(&quot;h1&quot;).each(function () {
        var $this = $(this);

        // ...on créé une div,
        $this.after(
            // ... on injecte le contenu du h1 dans la div,
            $(&quot;&lt;div&gt;&quot;).html($this.html())
        );
        // ...et supprime le h1.
        $this.remove();
    });

    // On recrée une nouvelle sortie HTML avec nos modifications.
    dom = $.html();

    // On réinjecte les modifications.
    next(dom);
};
</code></pre><p><em>controllers/index.js</em></p><pre><code class="lang-json">// On intervient avant que le DOM ne soit renvoyé au Client.
// Ce code sera exécuté uniquement lors de la demande de la page « / ».
exports.changeDom = function (params, next) {
    var NA = this,
        dom = params.dom,
        request = params.request,
        response = params.response,
        cheerio = NA.modules.cheerio, // Récupération de jsdom pour parcourir le DOM avec jQuery.
        $ = cheerio.load(dom, { decodeEntities: false }); // On charge les données pour les manipuler comme un DOM.

    // On modifie tous les contenu des noeuds avec la classe `.title`.
    $(&quot;.title&quot;).text(&quot;Modification de Contenu&quot;);

    // On recrée une nouvelle sortie HTML avec nos modifications.
    dom = $.html();

    // On réinjecte les modifications.
    next(dom);
};
</code></pre><p>ce qui produit la sortie suivante :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;Titre du site&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;Modification de Contenu&lt;/div&gt;
        &lt;div&gt;
            &lt;div&gt;Bienvenue&lt;/div&gt;
            &lt;p&gt;C&#39;est la page d&#39;accueil.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><h4 id="setsockets">setSockets</h4><p>Pour maintenir une connexion temps réel entre votre partie Cliente et Serveur à travers toutes les pages ouvertes sur tous les navigateurs de tous les ordinateurs sur le web, vous aller pouvoir définir vos Websockets ici <a href="#echange-client-serveur-en-temps-reel-avec-websockets">Plus de détail dans la partie Socket.IO</a>.</p><p>Voici un exemple utilisant les deux points d&#39;entrée, d&#39;abord la commune à plusieurs pages, puis celle de chaque page :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>avec cet ensemble de fichier :</p><pre><code>├─ assets/
│  └─ javascript/
│     └─ index.js
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json
</code></pre><p>En demandant la page <code>http://localhost/</code> les fichiers suivants (entre autre) seront utilisés :</p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;Exemple Websocket&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;layout&quot;&gt;
            &lt;div class=&quot;content&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;field&quot;&gt;Tape du texte : &lt;input class=&quot;input&quot; type=&quot;text&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;socket.io/socket.io.js&quot;&gt;&lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;node-atlas/socket.io.js&quot;&gt;&lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;javascript/index.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>controllers/common.js</em></p><pre><code class="lang-json">// On référence les actions de réponse et d&#39;envoi globaux côté serveur.
// Ce code sera exécuté pour toute entrée Websocket entrante.
exports.setSockets = function () {
    var NA = this,
        io = NA.io;

    io.on(&#39;connection&#39;, function (socket) {
        console.log(&quot;Un onglet est ouvert.&quot;);
        socket.on(&#39;disconnect&#39;, function () {
            console.log(&quot;Un onglet est fermé.&quot;);
        });
    });
};
</code></pre><p><em>controllers/index.js</em></p><pre><code class="lang-json">// On référence les actions de réponse et d&#39;envoi globaux côté serveur.
// Ce code sera exécuté pour toute entrée Websocket entrante.
exports.setSockets = function () {
    var NA = this,
        io = NA.io;

    // Attendre un lien valide entre client et serveur
    io.sockets.on(&quot;connection&quot;, function (socket) {

        // Quelqu&#39;un nous informe que le texte à changé.
        socket.on(&quot;update-text&quot;, function (data) {

            // On informe les autres que le texte à changé.
            io.sockets.emit(&quot;update-text&quot;, data);
        });
    });
};
</code></pre><p><em>assets/javascript/index.js</em></p><pre><code class="lang-json">var content = document.getElementsByClassName(&quot;content&quot;)[0],
    input = document.getElementsByClassName(&quot;input&quot;)[0];

// On alerte les autres de nos modifications.
input.addEventListener(&quot;keyup&quot;, function () {
    content.innerHTML = input.value;
    NA.socket.emit(&quot;update-text&quot;, {
        text: input.value
    });
});

// On récupère les modifications des autres.
NA.socket.on(&quot;update-text&quot;, function (data) {
    content.innerHTML = data.text;
    input.value = data.text;
});
</code></pre><p>Vous pourrez, en ouvrant divers navigateurs, et divers onglet, constaté que tout est bien mis à jour chez tout le monde. Chaque nouvel ongle ouvert affiche sur le serveur le message de connexion, et chaque onglet fermé, le message de deconnexion sur la console serveur.</p><h4 id="setmodules">setModules</h4><p>Pour charger d&#39;autres modules qui ne sont pas fournis avec NodeAtlas vous pouvez utiliser le contrôleur commun pour tout le site afin de les charger une seule fois et de les rendres disponible dans tous vos contrôleurs.</p><p>Voici un exemple utilisant un module externe à NodeAtlas :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>avec cet ensemble de fichier :</p><pre><code>├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json
</code></pre><p>En demandant la page <code>http://localhost/</code> les fichiers suivants (entre autre) seront utilisés :</p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;Test Module&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;Test Module&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Test Module&lt;/h1&gt;
            &lt;?- example ?&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>controllers/common.js</em></p><pre><code class="lang-json">// On intervient avant que la phase de chargement des modules ne soit achevée.
// Ce code sera exécuté au lancement de NodeAtlas.
exports.setModules = function () {
    // Récupérer l&#39;instance « NodeAtlas » du moteur.
    var NA = this;

    // Associations de chaque module pour y avoir accès partout.
    NA.modules.marked = require(&#39;marked&#39;);
};
</code></pre><p><em>controllers/index.js</em></p><pre><code class="lang-json">// On intervient avant que les variables soient injectées dans le système de template.
// Ce code sera exécuté uniquement lors de la demande de la page « / ».
exports.changeVariation = function (params, next) {
    // Récupérer l&#39;instance « NodeAtlas » du moteur.
    var NA = this,
        variation = params.variation,
        marked = NA.modules.marked;

    variation.example = marked(&quot;I am using __markdown__.&quot;);

    // On ré-injecte les modifications.
    next(variation);
};
</code></pre><p>ce qui produit la sortie suivante :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;Test Module&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;Test Module&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Test Module&lt;/h1&gt;
            &lt;p&gt;I am using &lt;strong&gt;markdown&lt;/strong&gt;.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><h4 id="setconfigurations">setConfigurations</h4><p>Pour configurer le serveur web de NodeAtlas (<a href="http://expressjs.com/">ExpressJs</a>) vous pouvez utiliser le contrôleur commun pour tout le site afin faire vos modifications avant le démarrage du serveur.</p><p>Voici un exemple utilisant un middleware pour <a href="http://expressjs.com/">ExpressJs</a> :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>avec cet ensemble de fichier :</p><pre><code>├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
└─ webconfig.json
</code></pre><p>En demandant la page <code>http://localhost/</code> les fichiers suivants (entre autre) seront utilisés :</p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;?- content ?&gt;
</code></pre><p><em>controllers/common.js</em></p><pre><code class="lang-json">// On intervient au niveau du serveur avant que celui-ci ne soit démarré.
// Ce code sera exécuté au lancement de NodeAtlas.
exports.setConfigurations = function (next) {
    // Récupérer l&#39;instance « NodeAtlas » du moteur.
    var NA = this;

    // Middleware utilisé lors de chaque requête.
    NA.httpServer.use(function (request, response, next) {
        response.setHeader(&quot;X-Frame-Options&quot;, &quot;ALLOW-FROM http://www.lesieur.name/&quot;);
        response.setHeader(&quot;Content-Type&quot;, &quot;application/json; charset=utf-8&quot;);
        next();
    });

    // On ré-injecte les modifications.
    next();
};
</code></pre><p><em>controllers/index.js</em></p><pre><code class="lang-json">// On intervient avant que les variables soient injectées dans le moteur de template.
// Ce code sera exécuté uniquement lors de la demande de la page « / ».
exports.changeVariation = function (params, next) {
    var variation = params.variation;

    // On prépare le fichier pour un affichage JSON.
    variation.content = JSON.stringify(variation, null, &quot;    &quot;);

    // On ré-injecte les modifications.
    next(variation);
};
</code></pre><p>ce qui produit la sortie suivante :</p><pre><code class="lang-html">{
    &quot;urlRootPath&quot;: &quot;http://localhost&quot;,
    &quot;urlSubPath&quot;: &quot;&quot;,
    &quot;urlBasePath&quot;: &quot;http://localhost&quot;,
    &quot;urlFilePath&quot;: &quot;/&quot;,
    &quot;urlQueryPath&quot;: &quot;&quot;,
    &quot;urlPath&quot;: &quot;http://localhost/&quot;,
    &quot;pathname&quot;: /* ... */,
    &quot;filename&quot;: /* ... */,
    &quot;params&quot;: {},
    &quot;currentRouteParameters&quot;: { /* ... */ },
    &quot;currentRoute&quot;: &quot;/&quot;,
    &quot;webconfig&quot;: { /* ... */ }
}
</code></pre><h4 id="setsessions">setSessions</h4><p>Pour configurer les sessions client-serveur de NodeAtlas vous pouvez utiliser le contrôleur commun pour tout le site afin de définir vos sessions avant le démarrage du serveur. Voici un exemple de management de Session avec <a href="http://redis.io/">Redis</a>.</p><p>Voici l&#39;ensemble de fichier suivant :</p><pre><code>├─ controllers/
│  └─ common.js
├─ views/
│  └─ index.htm
├─ variations/
│  ├─ common.json
│  └─ index.json
└─ webconfig.json
</code></pre><p>Avec le <code>webconfig.json</code> :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        }
    }
}
</code></pre><p>et avec le fichier « common.js » contenant par exemple :</p><pre><code class="lang-json">// On intervient avant que la phase de chargement des modules ne soit achevée.
// Ce code sera exécuté au lancement de NodeAtlas.
exports.setModules = function () {
    // Récupérer l&#39;instance « NodeAtlas » du moteur.
    var NA = this;

    // Associations de chaque module pour y avoir accès partout.
    NA.modules.RedisStore = require(&#39;connect-redis&#39;);
};

// On intervient au niveau du serveur pendant la configuration des Sessions.
// Ce code sera exécuté au lancement de NodeAtlas.
exports.setSessions = function (next) {
    var NA = this,
        session = NA.modules.session,
        RedisStore = NA.modules.RedisStore(session);

    // On remplace la session par default.
    NA.sessionStore = new RedisStore();

    // On redonne la main à NodeAtlas pour la suite.
    next();
};
</code></pre><h4 id="setroutes">setRoutes</h4><p>Pour configurer les routes de NodeAtlas dynamiquement vous pouvez utiliser le contrôleur commun pour tout le site afin de les charger une seule fois et de les rendres disponible dans tous vos contrôleurs.</p><p>Voici l&#39;ensemble de fichier suivant :</p><pre><code>├─ controllers/
│  └─ common.js
├─ views/
│  ├─ content.htm
│  └─ index.htm
├─ variations/
│  └─ common.json
└─ webconfig.json
</code></pre><p>Avec le <code>webconfig.json</code> :</p><pre><code class="lang-json">{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/index.html&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;
        }
    }
}
</code></pre><p>et avec le fichier « common.js » contenant par exemple :</p><pre><code class="lang-json">// On intervient au niveau des routes pendant qu&#39;elles sont ajoutées.
// Ce code sera exécuté au lancement de NodeAtlas.
exports.setRoutes = function (next) {

    // On récupère l&#39;instance de NodeAtlas en cours.
    var NA = this,

        // Et nous récupérons les routes en provenance du webconfig...
        route = NA.webconfig.routes;

    // ...pour ajouter la route &quot;/content.html&quot; à la liste de nos routes.
    route[&quot;/content.html&quot;] = {
        &quot;view&quot;: &quot;content.htm&quot;
    };

    // On redonne la main à NodeAtlas pour la suite.
    next(); 
};
</code></pre><h3 id="echange-client-serveur-en-temps-reel-avec-websockets">Échange Client-Serveur en temps réel avec Websockets</h3><p>Afin de conserver une liaison ouverte entre la partie Cliente et la partie Serveur de vos applications, NodeAtlas utilise <a href="http://socket.io/">Socket.IO</a> dont vous trouverez plus de détail sur le site officiel.</p><p>Grâce à cela, vous pourrez changer des informations en temps réel sur votre page, mais également sur toutes les autres pages ouvertes à travers tous les autres navigateurs.</p><p>Avec l&#39;ensemble de fichier suivant :</p><pre><code>├─ assets/
│  └─ javascript/
│     └─ index.js
├─ controllers/
│  └─ index.js
├─ variations/
│  ├─ common.json
│  └─ index.json
├─ views/
│  ├─ partials/
│  │  └─ index.htm
│  └─ index.htm
└─ webconfig.json
</code></pre><p>Contenant le <code>webconfig.json</code> suivant :</p><pre><code class="lang-json">{
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    }
}
</code></pre><p>et contenant les fichiers de template suivant :</p><p><em>views/partials/index.htm</em></p><pre><code class="lang-html">        &lt;div class=&quot;title&quot;&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;?- specific.content ?&gt;
            &lt;div&gt;&lt;?- new Date() ?&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;button&gt;Update&lt;/button&gt;
</code></pre><p><em>Note : Chaque clique sur <code>button</code> raffraichira le contenu de <code>views/partials/index.htm</code>.</em></p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;layout&quot;&gt;
            &lt;?- include(&#39;partials/index.htm&#39;) ?&gt;
        &lt;/div&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;socket.io/socket.io.js&quot;&gt;&lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;node-atlas/socket.io.js&quot;&gt;&lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;javascript/index.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>Note : On construit ici la page d&#39;accueil <code>/</code>.</em></p><p>ainsi que les fichiers de variations suivant :</p><p><em>variations/common.json</em></p><pre><code class="lang-json">{
    &quot;titleWebsite&quot;: &quot;Exemple Socket.IO&quot;
}
</code></pre><p><em>variations/index.json</em></p><pre><code class="lang-json">{
    &quot;titlePage&quot;: &quot;Date&quot;,
    &quot;content&quot;: &quot;&lt;p&gt;La date actuelle est :&lt;/p&gt;&quot;
}
</code></pre><p>Jusque là, rien d&#39;inhabituel et tout fonctionnerait sans partie contrôleur. Mais nous allons mettre en place la communication via Socket.IO côté Serveur puis côté Client.</p><p>Côté serveur, nous utiliserons le contrôleur commun suivant :</p><p><em>controllers/index.js</em></p><pre><code class="lang-json">// Intégralité des actions Websocket possible avec `setSockets`.
exports.setSockets = function () {
    var NA = this,
        io = NA.io;

    // Dès qu&#39;on a un lien valide entre le client et notre serveur...
    io.sockets.on(&quot;connection&quot;, function (socket) {

        // ...rester à l&#39;écoute de la demande « create-article-button »...
        socket.on(&quot;server-render&quot;, function (data) {
            var sessionID = socket.request.sessionID,
                session = socket.request.session,
                variation = {};

            // On récupère les variations spécifiques dans la bonne langue.
            variation = NA.addSpecificVariation(&quot;index.json&quot;, data.lang, variation);

            // On récupère les variations communes dans la bonne langue.
            variation = NA.addCommonVariation(data.lang, variation);

            // On récupère le fragment HTML depuis le dossier `viewsRelativePath` et on applique les variations.
            data.render = NA.newRender(&quot;partials/index.htm&quot;, variation);

            // Et on répond à tous les clients avec un jeu de donnée dans data.
            io.sockets.emit(&quot;server-render&quot;, data);
        });
    });
};
</code></pre><p>Quand au côté client, nous utiliserons les fichiers suivant :</p><p><em>assets/javascript/index.js</em></p><pre><code class="lang-json">var html = document.getElementsByTagName(&quot;html&quot;)[0],
    layout = document.getElementsByClassName(&quot;layout&quot;)[0];

// On associe sur le bouton l&#39;action de communiquer avec le serveur en cliquant dessus.
function setServerRender() {
    var button = document.getElementsByTagName(&quot;button&quot;)[0];
    button.addEventListener(&quot;click&quot;, function () {
        NA.socket.emit(&quot;server-render&quot;, {
            lang: html.getAttribute(&quot;lang&quot;)
        });
    });
}

// On affecte l&#39;action au bouton.
setServerRender();

// Quand le serveur répond après notre demande auprès de lui...
NA.socket.on(&quot;server-render&quot;, function (data) {

    // ...on met à jour le contenu...
    layout.innerHTML = data.render;

    // ...et ré-affectons l&#39;action au bouton du nouveau contenu.
    setServerRender();
});
</code></pre><p>Lancer votre projet et rendez-vous à l&#39;adresse <code>http://localhost/</code> dans deux onglets différent, voir même, dans deux navigateurs différent. Vous constaterez alors qu&#39;à chaque clique sur « Update », la page se remettra à jour (comme le montre la date courante) sur tous les onglets ouvert.</p><p>Grâce à <code>NA.addSpecificVariation</code>, <code>NA.addCommonVariation</code> et <code>NA.newRender</code>, il est possible de générer une nouvelle compilation d&#39;une vue et d&#39;une variation commune et spécifique.</p><p>Si <code>data.lang</code> dans notre exemple est de type <code>undefined</code>, alors les fichiers seront cherchés à la racine. Si <code>variation</code> est de type <code>undefined</code> alors un objet contenant uniquement le scope demandé sera renvoyé.</p><p>Note : pour permettre à <code>newRender</code> d&#39;utiliser le moteur PUG au lieu de celui d&#39;EJS, il faut mettre la valeur <code>variation.enablePug</code> à <code>true</code> avant d&#39;utiliser <code>NA.addCommonVariation</code> et <code>NA.addSpecificVariation</code>.</p><h3 id="utiliser-une-base-de-donnees-mysql-sql">Utiliser une base de données MySQL (SQL)</h3><p>Nous allons voir à présent comment utiliser des informations venant d&#39;une base de données. Pour cela nous allons utiliser le module npm <code>mysql</code>. Il va également nous falloir <a href="https://dev.mysql.com/downloads/installer/">installer un serveur MySQL</a>.</p><h4 id="base-de-donn-es-mysql">Base de données MySQL</h4><p>Tout d&#39;abord, nous allons alimenter la base de données avec la base <code>demo</code> :</p><pre><code class="lang-sql">CREATE DATABASE demo;
</code></pre><p>et la sélectionner :</p><pre><code class="lang-sql">USE demo
</code></pre><p>puis créer la table <code>user</code> :</p><pre><code class="lang-sql">CREATE TABLE user
(
    id INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    lastname VARCHAR(100),
    firstname VARCHAR(100),
    email VARCHAR(255),
    birthdate DATE,
    gender TINYINT(1),
    country VARCHAR(255),
    town VARCHAR(255),
    zipcode VARCHAR(5),
    address VARCHAR(255)
);
</code></pre><p>et la remplir avec un jeu de données :</p><pre><code class="lang-sql">INSERT INTO user (
    lastname,
    firstname,
    email,
    birthdate,
    gender,
    country,
    town,
    zipcode,
    address
) VALUES (
    &quot;Elric&quot;,
    &quot;Edward&quot;,
    &quot;edward.elric@fma.br&quot;,
    &quot;2006/01/01&quot;,
    true,
    &quot;Amestris&quot;,
    &quot;Resembool&quot;,
    00000,
    &quot;The Elric&#39;s house&quot;
);
INSERT INTO user (
    lastname,
    firstname,
    email,
    birthdate,
    gender,
    country,
    town,
    zipcode,
    address
) VALUES (
    &quot;Elric&quot;,
    &quot;Alphonse&quot;,
    &quot;alphonse.elric@fma.br&quot;,
    &quot;2008/01/01&quot;,
    true,
    &quot;Amestris&quot;,
    &quot;Resembool&quot;,
    00000,
    &quot;The Elric&#39;s house&quot;
);
</code></pre><h4 id="fichiers-nodeatlas">Fichiers NodeAtlas</h4><p>Voyons à présent l&#39;architecture de site que nous allons arbitrairement créer pour présenter notre exemple :</p><pre><code>├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ models/
│  ├─ objects/
│  │  └─ user.js
│  └─ connectors/
│     └─ user.js
├─ views/
│  └─ index.htm
├─ variations/
│  ├─ common.json
│  └─ index.json
└─ webconfig.json
</code></pre><p>Nous allons utiliser le <code>webconfig.json</code> suivant avec une variable custom <code>_mysqlConfig</code> qui contiendra toutes les informations pour se connecter à la base de données :</p><pre><code>{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    },
    &quot;_mysqlConfig&quot;: {
        &quot;host&quot;: &quot;localhost&quot;,
        &quot;user&quot;: &quot;root&quot;,
        &quot;password&quot;: &quot;root&quot;,
        &quot;database&quot;: &quot;demo&quot;
    }
}
</code></pre><p>Nous allons ensuite nous connecter à la base de données avec le controlleur globale <code>controllers/common.js</code> :</p><pre><code class="lang-json">exports.setModules = function () {
    var NA = this;

    // Import du module `mysql`.
    NA.modules.mysql = require(&#39;mysql&#39;);

    // Création de la collection de modèle...
    NA.models = {};
    // ...et récupération du modèle User avec accès à Mysql.
    NA.models.User = require(&#39;../models/connectors/user.js&#39;);
};

exports.setConfigurations = function (next) {
    var NA = this,
        path = NA.modules.path,
        mysql = NA.modules.mysql;

    // Délivre le modèle côté Client derrière l&#39;url `models/user.js`.
    NA.httpServer.use(
        NA.webconfig.urlRelativeSubPath + &quot;/models&quot;, 
        NA.modules.express.static(path.join(NA.serverPath, &quot;models/objects&quot;), { maxAge: 86400000 * 30 })
    );

    // Créer un pool de connexion à MySQL.
    NA.mySql = mysql.createPool(NA.webconfig._mysqlConfig);

    next();
};
</code></pre><p>Et afficher les résultats via le controlleur spécifique <code>controllers/index.js</code> :</p><pre><code class="lang-json">exports.changeVariation = function (params, next) {
    var NA = this,
        variation = params.variation,
        user = new NA.models.User(),
        user2 = new NA.models.User(),
        user3 = new NA.models.User(),
        user4 = new NA.models.User();

    // On récupère la connexion MySql.
    NA.mySql.getConnection(function(err, connection) {
        if (err) {
            throw err;
        }

        // Exemple de lecture.
        user
        .setConnection(connection)
        .lastname(&quot;Elric&quot;)
        .read(function (allUsers) {
            variation.user = user;
            variation.users = allUsers;

            // Exemple de création.
            user2
            .setConnection(connection)
            .firstname(&quot;Winry&quot;)
            .lastname(&quot;Rockbell&quot;)
            .email(&quot;winry.rockbell@fma.br&quot;)
            .gender(true)
            .create(function (infos) {
                variation.insertId = infos.insertId;
                variation.user2 = user2;

                // Exemple de modification.
                user3
                .gender(false)
                .birthdate(&quot;2008-01-01&quot;)
                .country(&quot;Amestris&quot;)
                .town(&quot;Resembool&quot;)
                .zipcode(&quot;99999&quot;)
                .address(&quot;The Rockbell&#39;s house&quot;);

                user2.update(user3, function (infos) {
                    variation.affectedRows = infos.affectedRows;
                    variation.user2 = user2;

                    // Exemple de suppression.
                    user4
                    .setConnection(connection)
                    .gender(false)
                    .delete(function (infos) {
                        variation.deletedRows = infos.affectedRows;
                        next(variation);
                    });
                });
            });
        });
    });
};
</code></pre><p>en utilisant le modèle <code>user</code> via le fichier de connexion à la base de données <code>models/connectors/user.js</code> :</p><pre><code class="lang-json">var user = require(&#39;../objects/user.js&#39;);

function User(connection) {
    var privates = {},
        publics = this;

    user.call(publics);

    privates.connection = connection;

    publics.setConnection = function (connection) {
        privates.connection = connection;
        return publics;
    };

    publics.read = function (callback) {
        var select = `SELECT
                    id,
                    lastname,
                    firstname,
                    email,
                    birthdate,
                    gender,
                    country,
                    town,
                    zipcode,
                    address
                FROM user`, 
            where = &quot;&quot;;

        if (publics.id()) { where += &#39; &amp;&amp; `id` = &#39; + publics.id(); }
        if (publics.lastname()) { where += &#39; &amp;&amp; `lastname` = &quot;&#39; + publics.lastname() + &#39;&quot;&#39;; }
        if (publics.firstname()) { where += &#39; &amp;&amp; `firstname` = &quot;&#39; + publics.firstname() + &#39;&quot;&#39;; }
        if (publics.email()) { where += &#39; &amp;&amp; `email` = &quot;&#39; + publics.email() + &#39;&quot;&#39;; }
        if (publics.birthdate()) { where += &#39; &amp;&amp; `birthdate` = &quot;&#39; + publics.birthdate() + &#39;&quot;&#39;; }
        if (typeof publics.gender() === &quot;boolean&quot;) { where += &#39; &amp;&amp; `gender` = &#39; + (publics.gender() ? 1 : 0); }
        if (publics.country()) { where += &#39; &amp;&amp; `country` = &quot;&#39; + publics.country() + &#39;&quot;&#39;; }
        if (publics.town()) { where += &#39; &amp;&amp; `town` = &quot;&#39; + publics.town() + &#39;&quot;&#39;; }
        if (publics.zipcode()) { where += &#39; &amp;&amp; `zipcode` = &quot;&#39; + publics.zipcode() + &#39;&quot;&#39;; }
        if (publics.address()) { where += &#39; &amp;&amp; `address` = &quot;&#39; + publics.address() + &#39;&quot;&#39;; }

        where = where.replace(&quot;&amp;&amp;&quot;, &quot;WHERE&quot;);

        privates.connection.query(select + where, function (err, rows) {
            var users = [],
                user;

            if (err) {
                throw err;
            }

            if (rows[0]) {
                publics.id(rows[0].id);
                publics.lastname(rows[0].lastname);
                publics.firstname(rows[0].firstname);
                publics.email(rows[0].email);
                publics.birthdate(rows[0].birthdate);
                publics.gender((rows[0].gender) ? true : false);
                publics.country(rows[0].country);
                publics.town(rows[0].town);
                publics.zipcode(rows[0].zipcode);
                publics.address(rows[0].address);
            }

            for (var i = 0; i &lt; rows.length; i++) {
                user = new User();
                user.id(rows[i].id);
                user.lastname(rows[i].lastname);
                user.firstname(rows[i].firstname);
                user.email(rows[i].email);
                user.birthdate(rows[i].birthdate);
                user.gender((rows[i].gender) ? true : false);
                user.country(rows[i].country);
                user.town(rows[i].town);
                user.zipcode(rows[i].zipcode);
                user.address(rows[i].address);
                users.push(user);
            }

            if (callback) {
                callback(users);
            }
        });

        return publics;
    };

    publics.create = function (callback) {
        var insert = &quot;INSERT INTO user (&quot;,
            values = &quot;) VALUES (&quot;;

        if (publics.id()) { insert += &quot;`id`, &quot;; }
        if (publics.lastname()) { insert += &quot;`lastname`, &quot;; }
        if (publics.firstname()) { insert += &quot;`firstname`, &quot;; }
        if (publics.email()) { insert += &quot;`email`, &quot;; }
        if (publics.birthdate()) { insert += &quot;`birthdate`, &quot;; }
        if (typeof publics.gender() === &quot;boolean&quot;) { insert += &quot;`gender`, &quot;; }
        if (publics.country()) { insert += &quot;`country`, &quot;; }
        if (publics.town()) { insert += &quot;`town`, &quot;; }
        if (publics.zipcode()) { insert += &quot;`zipcode`, &quot;; }
        if (publics.address()) { insert += &quot;`address`, &quot;; }

        insert = insert.replace(/, $/g, &quot;&quot;);

        if (publics.id()) { values += publics.id() + &#39;, &#39;; }
        if (publics.lastname()) { values += &#39;&quot;&#39; + publics.lastname() + &#39;&quot;, &#39;; }
        if (publics.firstname()) { values += &#39;&quot;&#39; + publics.firstname() + &#39;&quot;, &#39;; }
        if (publics.email()) { values += &#39;&quot;&#39; + publics.email() + &#39;&quot;, &#39;; }
        if (publics.birthdate()) { values += &#39;&quot;&#39; + publics.birthdate() + &#39;&quot;, &#39;; }
        if (typeof publics.gender() === &quot;boolean&quot;) { values += (publics.gender() ? 1 : 0) + &#39;, &#39;; }
        if (publics.country()) { values += &#39;&quot;&#39; + publics.country() + &#39;&quot;, &#39;; }
        if (publics.town()) { values += &#39;&quot;&#39; + publics.town() + &#39;&quot;, &#39;; }
        if (publics.zipcode()) { values += &#39;&quot;&#39; + publics.zipcode() + &#39;&quot;, &#39;; }
        if (publics.address()) { values += &#39;&quot;&#39; + publics.address() + &#39;&quot;, &#39;; }

        values = values.replace(/, $/g, &quot;)&quot;);

        privates.connection.query(insert + values, function (err, infos) {
            if (err) { 
                throw err;
            }

            publics.id(infos.insertId);

            if (callback) {
                callback(infos);
            }
        });

        return publics;
    };

    publics.update = function (user, callback) {
        var update = &quot;UPDATE user SET&quot;,
            where = &quot;&quot;;

        if (user.id()) { update += &#39;`id` = &#39; + user.id() + &#39;, &#39;; }
        if (user.lastname()) { update += &#39;`lastname` = &quot;&#39; + user.lastname() + &#39;&quot;, &#39;; }
        if (user.firstname()) { update += &#39;`firstname` = &quot;&#39; + user.firstname() + &#39;&quot;, &#39;; }
        if (user.email()) { update += &#39;`email` = &quot;&#39; + user.email() + &#39;&quot;, &#39;; }
        if (user.birthdate()) { update += &#39;`birthdate` = &quot;&#39; + user.birthdate() + &#39;&quot;, &#39;; }
        if (typeof user.gender() === &quot;boolean&quot;) { update += &#39;`gender` = &#39; + (user.gender() ? 1 : 0) + &#39;, &#39;; }
        if (user.country()) { update += &#39;`country` = &quot;&#39; + user.country() + &#39;&quot;, &#39;; }
        if (user.town()) { update += &#39;`town` = &quot;&#39; + user.town() + &#39;&quot;, &#39;; }
        if (user.zipcode()) { update += &#39;`zipcode` = &quot;&#39; + user.zipcode() + &#39;&quot;, &#39;; }
        if (user.address()) { update += &#39;`address` = &quot;&#39; + user.address() + &#39;&quot;, &#39;; }

        update = update.replace(/, $/g, &quot;&quot;);

        if (publics.id()) { where += &#39; &amp;&amp; `id` = &#39; + publics.id(); }
        if (publics.lastname()) { where += &#39; &amp;&amp; `lastname` = &quot;&#39; + publics.lastname() + &#39;&quot;&#39;; }
        if (publics.firstname()) { where += &#39; &amp;&amp; `firstname` = &quot;&#39; + publics.firstname() + &#39;&quot;&#39;; }
        if (publics.email()) { where += &#39; &amp;&amp; `email` = &quot;&#39; + publics.email() + &#39;&quot;&#39;; }
        if (publics.birthdate()) { where += &#39; &amp;&amp; `birthdate` = &quot;&#39; + publics.birthdate() + &#39;&quot;&#39;; }
        if (typeof publics.gender() === &quot;boolean&quot;) { where += &#39; &amp;&amp; `gender` = &#39; + (publics.gender() ? 1 : 0); }
        if (publics.country()) { where += &#39; &amp;&amp; `country` = &quot;&#39; + publics.country() + &#39;&quot;&#39;; }
        if (publics.town()) { where += &#39; &amp;&amp; `town` = &quot;&#39; + publics.town() + &#39;&quot;&#39;; }
        if (publics.zipcode()) { where += &#39; &amp;&amp; `zipcode` = &quot;&#39; + publics.zipcode() + &#39;&quot;&#39;; }
        if (publics.address()) { where += &#39; &amp;&amp; `address` = &quot;&#39; + publics.address() + &#39;&quot;&#39;; }

        where = where.replace(&quot;&amp;&amp;&quot;, &quot;WHERE&quot;);

        privates.connection.query(update + where, function (err, infos) {
            if (err) { 
                throw err;
            }

            if (user.id()) { publics.id(user.id()); }
            if (user.lastname()) { publics.lastname(user.lastname()); }
            if (user.firstname()) { publics.firstname(user.firstname()); }
            if (user.email()) { publics.email(user.email()); }
            if (user.birthdate()) { publics.birthdate(user.birthdate()); }
            if (typeof publics.gender() === &quot;boolean&quot;) { publics.gender(user.gender()); }
            if (user.country()) { publics.country(user.country()); }
            if (user.town()) { publics.town(user.town()); }
            if (user.zipcode()) { publics.zipcode(user.zipcode()); }
            if (user.address()) { publics.address(user.address()); }

            if (callback) {
                callback(infos);
            }
        });

        return publics;
    };

    publics.delete = function (callback) {
        var del = &quot;DELETE FROM user&quot;,
            where = &quot;&quot;;

        if (publics.id()) { where += &#39; &amp;&amp; `id` = &#39; + publics.id(); }
        if (publics.lastname()) { where += &#39; &amp;&amp; `lastname` = &quot;&#39; + publics.lastname() + &#39;&quot;&#39;; }
        if (publics.firstname()) { where += &#39; &amp;&amp; `firstname` = &quot;&#39; + publics.firstname() + &#39;&quot;&#39;; }
        if (publics.email()) { where += &#39; &amp;&amp; `email` = &quot;&#39; + publics.email() + &#39;&quot;&#39;; }
        if (publics.birthdate()) { where += &#39; &amp;&amp; `birthdate` = &quot;&#39; + publics.birthdate() + &#39;&quot;&#39;; }
        if (typeof publics.gender() === &quot;boolean&quot;) { where += &#39; &amp;&amp; `gender` = &#39; + (publics.gender() ? 1 : 0); }
        if (publics.country()) { where += &#39; &amp;&amp; `country` = &quot;&#39; + publics.country() + &#39;&quot;&#39;; }
        if (publics.town()) { where += &#39; &amp;&amp; `town` = &quot;&#39; + publics.town() + &#39;&quot;&#39;; }
        if (publics.zipcode()) { where += &#39; &amp;&amp; `zipcode` = &quot;&#39; + publics.zipcode() + &#39;&quot;&#39;; }
        if (publics.address()) { where += &#39; &amp;&amp; `address` = &quot;&#39; + publics.address() + &#39;&quot;&#39;; }

        where = where.replace(&quot;&amp;&amp;&quot;, &quot;WHERE&quot;);

        privates.connection.query(del + where, function (err, infos) {
            if (err) { 
                throw err;
            }

            if (publics.id()) { publics.id(undefined); }
            if (publics.lastname()) { publics.lastname(undefined); }
            if (publics.firstname()) { publics.firstname(undefined); }
            if (publics.email()) { publics.email(undefined); }
            if (publics.birthdate()) { publics.birthdate(undefined); }
            if (typeof publics.gender() === &quot;boolean&quot;) { publics.gender(undefined); }
            if (publics.country()) { publics.country(undefined); }
            if (publics.town()) { publics.town(undefined); }
            if (publics.zipcode()) { publics.zipcode(undefined); }
            if (publics.address()) { publics.address(undefined); }

            if (callback) {
                callback(infos);
            }
        });

        return publics;
    };
}

User.prototype = Object.create(user.prototype);
User.prototype.constructor = User;

module.exports = User;
</code></pre><p>basé sur une classe <code>user</code> partagée entre la partie cliente et serveur <code>models/objects/user.js</code> :</p><pre><code class="lang-json">(function (expose, factory) {
    if (typeof module !== &#39;undefined&#39; &amp;&amp; module.exports) {
        module.exports = factory;
    } else {
        expose.User = factory;
    }
}(this, function User() {
    var privates = {},
        publics = this;

    publics.id = function (id) {
        if (typeof id === &#39;undefined&#39;) {
            return privates.id;
        } else {
            privates.id = id;
            return publics;
        }
    };

    publics.lastname = function (lastname) {
        if (typeof lastname === &#39;undefined&#39;) {
            return privates.lastname;
        } else {
            privates.lastname = lastname;
            return publics;
        }
    };

    publics.firstname = function (firstname) {
        if (typeof firstname === &#39;undefined&#39;) {
            return privates.firstname;
        } else {
            privates.firstname = firstname;
            return publics;
        }
    };

    publics.email = function (email) {
        if (typeof email === &#39;undefined&#39;) {
            return privates.email;
        } else {
            privates.email = email;
            return publics;
        }
    };

    publics.birthdate = function (birthdate) {
        if (typeof birthdate === &#39;undefined&#39;) {
            return privates.birthdate;
        } else {
            privates.birthdate = birthdate;
            return publics;
        }
    };

    publics.gender = function (gender) {
        if (typeof gender === &#39;undefined&#39;) {
            return privates.gender;
        } else {
            privates.gender = gender;
            return publics;
        }
    };

    publics.country = function (country) {
        if (typeof country === &#39;undefined&#39;) {
            return privates.country;
        } else {
            privates.country = country;
            return publics;
        }
    };

    publics.town = function (town) {
        if (typeof town === &#39;undefined&#39;) {
            return privates.town;
        } else {
            privates.town = town;
            return publics;
        }
    };

    publics.zipcode = function (zipcode) {
        if (typeof zipcode === &#39;undefined&#39;) {
            return privates.zipcode;
        } else {
            privates.zipcode = zipcode;
            return publics;
        }
    };

    publics.address = function (address) {
        if (typeof address === &#39;undefined&#39;) {
            return privates.address;
        } else {
            privates.address = address;
            return publics;
        }
    };
}));
</code></pre><p>Avec les fichiers suivant pour afficher la page :</p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;div class=&quot;first&quot;&gt;
                &lt;?- specific.content ?&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;&lt;?- user.id() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;&lt;?- user.lastname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;&lt;?- user.firstname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;&lt;?- user.email() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;&lt;?- user.birthdate() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;&lt;?- user.gender() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;&lt;?- user.country() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;&lt;?- user.town() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;&lt;?- user.zipcode() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;&lt;?- user.address() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
            &lt;div class=&quot;all&quot;&gt;
                &lt;?- specific.contents ?&gt;
                &lt;? for (var i = 0; i &lt; users.length; i++) { ?&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;&lt;?- users[i].id() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;&lt;?- users[i].lastname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;&lt;?- users[i].firstname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;&lt;?- users[i].email() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;&lt;?- users[i].birthdate() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;&lt;?- users[i].gender() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;&lt;?- users[i].country() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;&lt;?- users[i].town() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;&lt;?- users[i].zipcode() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;&lt;?- users[i].address() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;? } ?&gt;
            &lt;/div&gt;
            &lt;div class=&quot;last&quot;&gt;
                &lt;?- specific.contentInsert ?&gt;
                &lt;p&gt;insertId: &lt;?- insertId ?&gt;&lt;/p&gt;
                &lt;p&gt;numberUpdate: &lt;?- affectedRows ?&gt;&lt;/p&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;&lt;?- user2.id() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;&lt;?- user2.lastname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;&lt;?- user2.firstname() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;&lt;?- user2.email() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;&lt;?- user2.birthdate() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;&lt;?- user2.gender() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;&lt;?- user2.country() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;&lt;?- user2.town() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;&lt;?- user2.zipcode() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;&lt;?- user2.address() ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;p&gt;numberDelete: &lt;?- deletedRows ?&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>variations/common.json</em></p><pre><code class="lang-json">{
    &quot;titleWebsite&quot;: &quot;Exemple MySql&quot;,
    &quot;male&quot;: &quot;Homme&quot;,
    &quot;female&quot;: &quot;Femme&quot;
}
</code></pre><p><em>variations/index.json</em></p><pre><code class="lang-json">{
    &quot;titlePage&quot;: &quot;Table User&quot;,
    &quot;content&quot;: &quot;&lt;p&gt;Détail de la première entrée.&lt;/p&gt;&quot;,
    &quot;contents&quot;: &quot;&lt;p&gt;Détail de toutes les entrées.&lt;/p&gt;&quot;,
    &quot;contentInsert&quot;: &quot;&lt;p&gt;Détail de l&#39;utilisateur ajouté puis modifié.&lt;/p&gt;&quot;
}
</code></pre><p>Vous obtiendrez la sortie suivante :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr-fr&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;MySql Exemple&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;MySql Exemple&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Table User&lt;/h1&gt;
            &lt;div class=&quot;first&quot;&gt;
                &lt;p&gt;Détail de la première entrée.&lt;/p&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;1&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;Elric&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;Edward&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;edward.elric@fma.br&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;Sun Jan 01 2006 00:00:00 GMT+0100 (Paris, Madrid)&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;true&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;Amestris&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;Resembool&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;0&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;The Elric&#39;s house&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
            &lt;div class=&quot;all&quot;&gt;
                &lt;p&gt;Détail de toutes les entrées.&lt;/p&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;1&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;Elric&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;Edward&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;edward.elric@fma.br&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;Sun Jan 01 2006 00:00:00 GMT+0100 (Paris, Madrid)&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;true&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;Amestris&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;Resembool&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;0&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;The Elric&#39;s house&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;2&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;Elric&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;Alphonse&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;alphonse.elric@fma.br&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;Tue Jan 01 2008 00:00:00 GMT+0100 (Paris, Madrid)&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;true&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;Amestris&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;Resembool&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;0&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;The Elric&#39;s house&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
            &lt;div class=&quot;last&quot;&gt;
                &lt;p&gt;Détail de l&#39;utilisateur ajouté puis modifié.&lt;/p&gt;
                &lt;p&gt;insertId: 3&lt;/p&gt;
                &lt;p&gt;numberUpdate: 1&lt;/p&gt;
                &lt;ul&gt;
                    &lt;li&gt;Id: &lt;strong&gt;3&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Lastname: &lt;strong&gt;Rockbell&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Firstname: &lt;strong&gt;Winry&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Email: &lt;strong&gt;winry.rockbell@fma.br&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Birthdate: &lt;strong&gt;2008-01-01&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Gender: &lt;strong&gt;false&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Country: &lt;strong&gt;Amestris&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Town: &lt;strong&gt;Resembool&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Zipcode: &lt;strong&gt;99999&lt;/strong&gt;&lt;/li&gt;
                    &lt;li&gt;Address: &lt;strong&gt;The Rockbell&#39;s house&lt;/strong&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;p&gt;numberDelete: 1&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><h3 id="utiliser-une-base-de-donnees-mongodb-nosql">Utiliser une base de données MongoDB (NoSQL)</h3><p>Nous allons voir à présent comment utiliser des informations venant d&#39;une base de données non sql. Pour cela nous allons utiliser le module npm <code>mongoose</code>. Il va également nous falloir <a href="https://www.mongodb.com/">installer un serveur MongoDB</a>.</p><h4 id="base-de-donn-es-mongodb">Base de données MongoDB</h4><p>Tout d&#39;abord, nous allons alimenter la base de données avec la base <code>demo</code> et la sélectionner :</p><pre><code>use demo
</code></pre><p>puis créer la collection <code>user</code> :</p><pre><code>db.createCollection(&quot;user&quot;)
</code></pre><p>et la remplir avec un document :</p><pre><code>db.user.insert({
    email: &quot;bruno.lesieur@gmail.com&quot;,
    identity: {
        lastname: &quot;Lesieur&quot;,
        firstname: &quot;Bruno&quot;,
        gender: true,
        birthdate : new Date(&quot;1988/07/18&quot;)
    },
    location: {
        country: &quot;France&quot;,
        town: &quot;Annecy&quot;,
        zipcode: &quot;74000&quot;,
        address: &quot;66 avenue de Genève&quot;
    }
})
</code></pre><h4 id="fichiers-nodeatlas">Fichiers NodeAtlas</h4><p>Avec le jeu de fichier suivant :</p><pre><code>├─ assets/
│  └─ javascript/
│     └─ models/
│        └─ user.js
├─ controllers/
│  ├─ common.js
│  └─ index.js
├─ views/
│  └─ index.htm
├─ variations/
│  ├─ common.json
│  └─ index.json
└─ webconfig.json
</code></pre><p>Nous allons utiliser le <code>webconfig.json</code> suivant avec une variable custom <code>_mongodbConfig</code> qui contiendra toutes les informations pour se connecter à la base de données :</p><pre><code>{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;view&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;controller&quot;: &quot;index.js&quot;
        }
    },
    &quot;_mongodbConfig&quot;: {
        &quot;host&quot;: &quot;localhost&quot;,
        &quot;port&quot;: &quot;27017&quot;,
        &quot;database&quot;: &quot;demo&quot;
    }
}
</code></pre><p>Avec les fichiers suivant pour afficher la page :</p><p><em>views/index.htm</em></p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;&lt;?- languageCode ?&gt;&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;&lt;?- common.titleWebsite ?&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;&lt;?- common.titleWebsite ?&gt;&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;&lt;?- specific.titlePage ?&gt;&lt;/h1&gt;
            &lt;?- specific.content ?&gt;
            &lt;ul&gt;
                &lt;li&gt;Id: &lt;strong&gt;&lt;?- id ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Lastname: &lt;strong&gt;&lt;?- lastname ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Firstname: &lt;strong&gt;&lt;?- firstname ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Email: &lt;strong&gt;&lt;?- email ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Birthdate: &lt;strong&gt;&lt;?- birthdate ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Gender: &lt;strong&gt;&lt;?- gender ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Country: &lt;strong&gt;&lt;?- country ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Town: &lt;strong&gt;&lt;?- town ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Zipcode: &lt;strong&gt;&lt;?- zipcode ?&gt;&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Address: &lt;strong&gt;&lt;?- address ?&gt;&lt;/strong&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p><em>variations/common.json</em></p><pre><code class="lang-json">{
    &quot;titleWebsite&quot;: &quot;MongoDB Exemple&quot;,
    &quot;male&quot;: &quot;Homme&quot;,
    &quot;female&quot;: &quot;Femme&quot;
}
</code></pre><p><em>variations/index.json</em></p><pre><code class="lang-json">{
    &quot;titlePage&quot;: &quot;Collection User&quot;,
    &quot;content&quot;: &quot;&lt;p&gt;Détail du document `{ \&quot;identity.firstname\&quot;: \&quot;Bruno\&quot; }`.&lt;/p&gt;&quot;
}
</code></pre><p>Enfin nous allons nous connecter à la base de données avec le controlleur globale <code>controllers/common.js</code> :</p><pre><code class="lang-json">exports.setModules = function () {
    var NA = this,
        path = NA.modules.path;

    NA.modules.mongoose = require(&#39;mongoose&#39;);
    NA.models = {};
    NA.models.User = require(&#39;../assets/javascript/models/user.js&#39;);
};

exports.setConfigurations = function (next) {
    var NA = this,
        mongoose = NA.modules.mongoose,
        config = NA.webconfig._mongodbConfig;

    mongoose.Promise = global.Promise;
    mongoose.model(&quot;user&quot;, NA.models.User, &quot;user&quot;);
    mongoose.connect(&quot;mongodb://&quot; + config.host + &quot;:&quot; + config.port + &quot;/&quot; + config.database, function (error) {
        next();
    });
};
</code></pre><p>Et afficher les résultats via le controlleur spécifique <code>controllers/index.js</code> :</p><pre><code class="lang-json">exports.changeVariation = function (params, next) {
    var NA = this,
        variation = params.variation,
        mongoose = NA.modules.mongoose,
        User = mongoose.model(&#39;user&#39;);

    User
    .findOne({ &quot;identity.firstname&quot;: &quot;Bruno&quot; })
    .exec(function (err, bruno) {

        variation.id = bruno._id;
        variation.lastname = bruno.identity.lastname;
        variation.firstname = bruno.identity.firstname;
        variation.birthdate = bruno.identity.birthdate;
        variation.email = bruno.email;
        variation.gender = (bruno.identity.gender) ? variation.common.male : variation.common.female;
        variation.country = bruno.location.country;
        variation.town = bruno.location.town;
        variation.zipcode = bruno.location.zipcode;
        variation.address = bruno.location.address;

        next(variation);
    });
};
</code></pre><p>en utilisant sur une classe <code>user</code> partagé entre le Front et le Back <code>assets/javascript/models/user.js</code> :</p><pre><code class="lang-json">var mongoose;
if (typeof module !== &#39;undefined&#39; &amp;&amp; module.exports) {
     mongoose = require(&#39;mongoose&#39;);
}

(function (expose, factory) {
    if (mongoose) {
        module.exports = factory;
    } else {
        expose.User = factory;
    }
}(this, new mongoose.Schema({
    _id: mongoose.Schema.Types.ObjectId,
    email: { type : String, match: /^\S+@\S+$/ },
    identity: {
        lastname: String,
        firstname: String,
        gender: Boolean,
        birthdate : { type : Date, default : Date.now }
    },
    location: {
        country: String,
        town: String,
        zipcode: String,
        address: String
    }
})));
</code></pre><p>Vous obtiendrez la sortie suivante :</p><pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot; /&gt;
        &lt;title&gt;Exemple MongoDB&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class=&quot;title&quot;&gt;Exemple MongoDB&lt;/div&gt;
        &lt;div&gt;
            &lt;h1&gt;Collection User&lt;/h1&gt;
            &lt;p&gt;Détail de l&#39;entrée `{ &quot;identity.firstname&quot;: &quot;Bruno&quot; }`.&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;Id: &lt;strong&gt;5804d4d530788ee2e52ea1c7&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Lastname: &lt;strong&gt;Lesieur&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Firstname: &lt;strong&gt;Bruno&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Email: &lt;strong&gt;bruno.lesieur@gmail.com&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Birthdate: &lt;strong&gt;Mon Jul 18 1988 00:00:00 GMT+0200 (Paris, Madrid (heure d’été))&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Gender: &lt;strong&gt;Homme&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Country: &lt;strong&gt;France&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Town: &lt;strong&gt;Annecy&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Zipcode: &lt;strong&gt;74000&lt;/strong&gt;&lt;/li&gt;
                &lt;li&gt;Address: &lt;strong&gt;66 avenue de Genève&lt;/strong&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>