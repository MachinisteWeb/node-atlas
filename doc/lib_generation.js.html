<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/generation.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/generation.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*------------------------------------*\
    ASSETS GENERATION
\*------------------------------------*/
/* jslint node: true */

/**
 * Copy content of a project from NodeAtlas `templates/` folder into current directory.
 * @private
 * @function createTemplateProject
 * @memberOf NA#
 * @this NA
 * @param {NA~fallback} next Fallback function.
 */
exports.createTemplateProject = function (next) {
     var NA = this,
        fs = NA.modules.fs,
        path = NA.modules.path,
        copyDir = NA.modules.copyDir,
        source = (typeof NA.configuration.create === "string") ? NA.configuration.create : "hello-world",
        sourcePath = path.join(NA.nodeatlasPath, "templates", source),
        destinationPath = path.join(NA.serverPath),
        data = {};

    if (NA.configuration.create) {

        /* Copy starting project from `templates/` directory. By default it is "hello-world". */
        if (sourcePath !== destinationPath &amp;&amp; fs.existsSync(sourcePath)) {

            copyDir(sourcePath, destinationPath, function () {   
                data.pathName = sourcePath;
                NA.log(NA.cliLabels.initCopy.replace(/%([\-a-zA-Z0-9_]+)%/g, function (regex, matches) { return data[matches]; }));
                if (NA.afterNewProject) {
                    NA.afterNewProject.call(NA);
                }
            });
        } else {
            data.initPath = source;
            NA.log(NA.cliLabels.initNotFound.replace(/%([\-a-zA-Z0-9_]+)%/g, function (regex, matches) { return data[matches]; }));
        }
    } else {

        /**
         * Continue with this alternative way if main operation not possible.
         * @callback NA~fallback
         */
        next();
    }
};

/**
 * Open all pages for generate HTML render into `serverlessRelativePath`.
 * @private
 * @function generateHTML
 * @memberOf NA~
 * @param {NA} NA NodeAtlas instance.
 */
function generateHTML(NA) {
    var output = false;

    /* Avoid copy of `assetsRelativePath` into `serverlessRelativePath` even if serverlessRelativePath directory exist. */
    if (typeof NA.webconfig.output === "boolean") {

        /**
         * Disable HTML generation mechanism.
         * @public
         * @alias output
         * @type {boolean}
         * @memberOf NA#webconfig
         * @default true
         */
        output = NA.webconfig.output;
    }

    /* Generation only if is configured to « true » in `generate` or set co command line. */
    if (NA.configuration.generate) {

        /* Generate all HTML files. */
        if (output) {
            NA.forEach(NA.webconfig.routes, function (currentUrl) {
                NA.prepareResponse(currentUrl, NA.webconfig.routes, undefined, undefined, function (locals, routeParameters, request, response, viewsPath, currentPath) {
                    NA.changeVariationsCommon(locals, routeParameters, request, response, viewsPath, currentPath);
                });
            });
        }

        NA.generateAssets();
    }
}

/**
 * Crawl all routes and generate them after passed into `NA#controllers[].setRoutes` hook.
 * @private
 * @function initOutputs
 * @memberOf NA#
 * @this NA
 */
exports.initOutputs = function () {
    var NA = this;

    if (typeof NA.controllers[NA.webconfig.controller] !== 'undefined' &amp;&amp;
        typeof NA.controllers[NA.webconfig.controller].setRoutes !== 'undefined') {
            NA.controllers[NA.webconfig.controller].setRoutes.call(NA, function () {
                generateHTML(NA);
            });
    } else {
        generateHTML(NA);
    }
};

/**
 * Compress all assets for generate `assetsRelativePath` content into `serverlessRelativePath` and copy all `NA#statics` directories..
 * @private
 * @function generateAssets
 * @memberOf NA#
 * @this NA
 */
exports.generateAssets = function () {
    var NA = this,
        async = NA.modules.async;

    /* Generate all minified CSS, JS and Images files. */
    async.parallel([
        NA.cssCompilation.bind(NA),
        NA.jsObfuscation.bind(NA),
        NA.imgOptimization.bind(NA),
    ], function () {

        /* Copy all content of `assetsRelativePath` and `statics` into `serverlessRelativePath` */
        async.parallel([
            NA.publicsGeneration.bind(NA),
            NA.staticsGeneration.bind(NA),
        ], function () {

            if (NA.afterGeneration) {
                NA.afterGeneration.call(NA);
            }
        });
    });
};

/**
 * Copy all `public` file from `assetsRelativePath` to `serverlessRelativePath`.
 * @private
 * @function publicsGeneration
 * @memberOf NA#
 * @this NA
 * @param {NA~callback} next Next step after copy of all `assetsRelativePath` content.
 */
exports.publicsGeneration = function (next) {
    var NA = this,
        path = NA.modules.path,
        fs = NA.modules.fs,
        copyDir = NA.modules.copyDir,
        sourcePath = path.join(NA.serverPath, NA.webconfig.assetsRelativePath),
        destinationPath = path.join(NA.serverPath, NA.webconfig.serverlessRelativePath),
        assetsCopy = false;

    /* Avoid copy of `assetsRelativePath` into `serverlessRelativePath` even if serverlessRelativePath directory exist. */
    if (typeof NA.webconfig.assetsCopy === "boolean") {

        /**
         * Disable Assets generation mechanism.
         * @public
         * @alias assetsCopy
         * @type {boolean}
         * @memberOf NA#webconfig
         * @default true
         */
        assetsCopy = NA.webconfig.assetsCopy;
    }

    if (assetsCopy &amp;&amp; sourcePath !== destinationPath &amp;&amp; fs.existsSync(sourcePath)) {
        copyDir(sourcePath, destinationPath, function () {        
            NA.log(NA.cliLabels.assetsCopy);
            next();
        });
    } else {
        next();
    }
};

/**
 * Copy mechanism for statics.
 * @private
 * @function traverse
 * @memberOf NA~
 * @this NA
 * @param {Object}      paths         Contain a `statics` content.
 * @param {string}      paths.real    The path of source directory.
 * @param {string}      paths.virtual The path of virtual url.
 * @param {boolean}     paths.output  Inform if copy is required
 * @param {NA~callback} next          Go to next steps.
 */
function traverse(paths, next) {
    var NA = this,
        copyDir = NA.modules.copyDir,
        path = NA.modules.path,
        sourcePath = path.join(NA.serverPath, paths.real),
        destinationPath = path.join(NA.serverPath, NA.webconfig.serverlessRelativePath, paths.virtual),
        data = {
            source: sourcePath,
            dest: destinationPath
        };

    if (paths.output) {
        copyDir(sourcePath, destinationPath, function () {
            NA.log(NA.cliLabels.staticsCopy.replace(/%([\-a-zA-Z0-9_]+)%/g, function (regex, matches) { return data[matches]; }));    
            next();
        });
    } else {
        next();
    }
}

/**
 * Copy all `statics` form real directory to `serverlessRelativePath`.
 * @private
 * @function staticsGeneration
 * @memberOf NA#
 * @this NA
 * @param {NA~callback} next Next step after copy of all `assetsRelativePath` content.
 */
exports.staticsGeneration = function (next) {
    var NA = this,
        async = NA.modules.async,
        statics = [];

    if (NA.webconfig.statics) {
        
        NA.forEach(NA.webconfig.statics, function (directory, directories) {
            var virtual = directory,
                real = directories[directory],
                output = false;

            if (NA.webconfig.statics instanceof Array) {
                virtual = directory.virtual;
                output = directory.output;
                real = directory;
            }

            if (typeof real === "object") {
                output = (typeof real.output === "boolean" &amp;&amp; !real.output) ? false : true;
                real = real.path;
            }

            statics.push({
                real: real,
                virtual: virtual,
                output: output
            });
        });

        async.map(statics, traverse.bind(NA), function() {
            next();
        });
    } else {
        next();
    }
};

/**
 * Save the render.
 * @private
 * @function save
 * @memberOf NA~
 * @param {NA}     NA           NodeAtlas instance.
 * @param {string} html         HTML result to save.
 * @param {string} data         Result if html is not a HTML content.
 * @param {string} templateName Name for register file.
 */
function save(NA, html, data, templateName) {
    var mkpath = NA.modules.mkpath,
        path = NA.modules.path,
        pathToSaveFileComplete = path.join(NA.serverPath, NA.webconfig.serverlessRelativePath, templateName),
        pathToSaveFile = path.dirname(pathToSaveFileComplete),
        fs = NA.modules.fs;

    /* Create file render. */
    mkpath(pathToSaveFile, function () {
        var dataError = {};

        /* If source is not a HTML format, keep initial data format. */
        if (data.trim().match(/&lt;\/html>$/g) === null) {
            html = data;
        }

        dataError.pathName = path.join(NA.serverPath, NA.webconfig.serverlessRelativePath, templateName);

        /* Write file */
        fs.writeFile(pathToSaveFileComplete, html, function (error) {
            if (error) {
                if (error.code === 'EISDIR' || error.code === 'ENOENT') {
                    NA.log(NA.cliLabels.templateNotGenerate.replace(/%([\-a-zA-Z0-9_]+)%/g, function (regex, matches) { return dataError[matches]; }));
                } else {
                    throw error;
                }
            } else {
                NA.log(NA.cliLabels.templateGenerate.replace(/%([\-a-zA-Z0-9_]+)%/g, function (regex, matches) { return dataError[matches]; }));
            }
        });

    });
}

/**
 * Generate a template into an HTML file in folder `serverlessRelativePath`.
 * @private
 * @function saveRender
 * @memberOf NA#
 * @this NA
 * @param {string} data         Content of file generated.
 * @param {string} templateName The filename of file generated.
 */
exports.saveRender = function (data, templateName) {
    var NA = this,
        cheerio = NA.modules.cheerio,
        $ = cheerio.load(data, { decodeEntities: false }),
        deeper,
        newBase = "";

    /*
     * If false, no generate for this line.
     */
    if (templateName !== false) {

        /*
         * If templateName ending with "/", remove it.
         */
        templateName = templateName.replace(/\/$/g, "");

        /*
         * If a &lt;base> markup exist, calculation of
         * relative placement of page under root folder...
         */
        deeper = templateName.split("/").length - 1;
        if (templateName[0] === "/") {
            deeper = templateName.split("/").length - 2;
        }

        /* ...and creation of path for all resources */
        for (var i = 0; i &lt; deeper; i++) {
            newBase += "../";
        }

        /* ...and set new base */
        $("base").attr("href", newBase.replace(/\/$/, ""));

        /* Save the render. */
        save(NA, $.html(), data, (templateName) ? templateName : "");
    }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-node-atlas.html">node-atlas</a></li></ul><h3>Externals</h3><ul><li><a href="NA_modules.external_async.html">async</a></li><li><a href="NA_modules.external_body-parser.html">body-parser</a></li><li><a href="NA_modules.external_cheerio.html">cheerio</a></li><li><a href="NA_modules.external_clean-css.html">clean-css</a></li><li><a href="NA_modules.external_commander.html">commander</a></li><li><a href="NA_modules.external_compression.html">compression</a></li><li><a href="NA_modules.external_cookie-parser.html">cookie-parser</a></li><li><a href="NA_modules.external_copy-dir.html">copy-dir</a></li><li><a href="NA_modules.external_css-parse.html">css-parse</a></li><li><a href="NA_modules.external_ejs.html">ejs</a></li><li><a href="NA_modules.external_express.html">express</a></li><li><a href="NA_modules.external_express-session.html">express-session</a></li><li><a href="NA_modules.external_extend.html">extend</a></li><li><a href="NA_modules.external_forcedomain.html">forcedomain</a></li><li><a href="NA_modules.external_imagemin.html">imagemin</a></li><li><a href="NA_modules.external_less.html">less</a></li><li><a href="NA_modules.external_less-middleware.html">less-middleware</a></li><li><a href="NA_modules.external_mkpath.html">mkpath</a></li><li><a href="NA_modules.external_open.html">open</a></li><li><a href="NA_modules.external_pug.html">pug</a></li><li><a href="NA_modules.external_socketio.html">socketio</a></li><li><a href="NA_modules.external_stylus.html">stylus</a></li><li><a href="NA_modules.external_uglify-js.html">uglify-js</a></li></ul><h3>Classes</h3><ul><li><a href="NA.html">NA</a></li></ul><h3>Namespaces</h3><ul><li><a href="NA_controllers%255B%255D.html">controllers[]</a></li><li><a href="NA_locals.html">locals</a></li><li><a href="NA_modules.html">modules</a></li><li><a href="NA_routeParameters.html">routeParameters</a></li><li><a href="NA_webconfig.html">webconfig</a></li><li><a href="NA_webconfig.less.html">less</a></li><li><a href="NA_webconfig.stylus.html">stylus</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Feb 07 2017 13:45:18 GMT+0100 (Paris, Madrid)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
